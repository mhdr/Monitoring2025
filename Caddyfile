# Caddy Reverse Proxy Configuration
# Monitoring2025 - Unified HTTPS Gateway

# Domain or IP address (replace with your actual domain/IP)
# For development: localhost:8443
# For production: monitoring.yourdomain.com
{$CADDY_DOMAIN:localhost:8443} {
    # Enable automatic HTTPS (Let's Encrypt)
    # For local development, Caddy will use self-signed certificates
    # For production with a real domain, it will use Let's Encrypt
    
    # Security headers
    header {
        # HSTS - Force HTTPS for 1 year
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # XSS protection
        X-Content-Type-Options "nosniff"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Content Security Policy (adjust as needed)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:;"
    }

    # Frontend UI - React/Vite app on port 5173
    handle /* {
        reverse_proxy localhost:5173 {
            # Enable WebSocket support for Vite HMR and SignalR
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            
            # Health check
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Backend API - ASP.NET Core on port 5030
    handle /api/* {
        reverse_proxy localhost:5030 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            
            # Health check
            health_uri /api/health
            health_interval 10s
            health_timeout 5s
        }
    }

    # SignalR Hub - WebSocket support
    handle /hubs/* {
        reverse_proxy localhost:5030 {
            # Essential for SignalR/WebSocket
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
            
            # WebSocket transport timeouts
            transport http {
                read_timeout 60s
                write_timeout 60s
            }
        }
    }

    # Swagger/OpenAPI documentation (optional, remove in production)
    handle /swagger/* {
        reverse_proxy localhost:5030 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Access logs (optional)
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }

    # Error logs
    log {
        output file /var/log/caddy/error.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        level ERROR
    }
}

# Alternative configuration for production with custom domain
# Uncomment and modify for production deployment:

# monitoring.yourdomain.com {
#     # Automatic HTTPS with Let's Encrypt
#     tls {
#         # Use your email for Let's Encrypt notifications
#         email admin@yourdomain.com
#     }
#
#     # Production UI (served by Express/PM2 on a different port)
#     handle /* {
#         reverse_proxy localhost:3000
#     }
#
#     # Production API
#     handle /api/* {
#         reverse_proxy localhost:5030
#     }
#
#     handle /hubs/* {
#         reverse_proxy localhost:5030
#     }
# }
