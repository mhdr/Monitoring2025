import{bI as e,bQ as a}from"./vendor-TAwwu7tv.js";import{a as t,e as i,c as r}from"./layout-C1_h6sDC.js";import{L as d}from"./api-D5q9v5qU.js";import{f as l}from"./dateFormatting-Oyh3Sj-d.js";import{u as s,z as o,E as n,a as u,F as c,w as g,B as p,x as h,D as m,O as x,v as f,a1 as T,P as y,a2 as b,a3 as j,a4 as P,a5 as w,a6 as A}from"./mui-core-im59jMHH.js";const v=r(),k=({open:r,onClose:k,data:D})=>{const{t:E,language:W}=t(),C=s(),{state:O}=i(),R=O.items,S=e.useCallback(e=>{if(!e)return E("auditTrailPage.detailDialog.notApplicable");const a=R.find(a=>a.id===e);return a?"fa"===W&&a.nameFa||a.name:E("auditTrailPage.detailDialog.unknownPoint")},[R,W,E]),V=e.useCallback(e=>{if(!e)return E("auditTrailPage.detailDialog.notApplicable");const a=O.groups.find(a=>a.id===e);return a?"fa"===W&&a.nameFa||a.name:E("auditTrailPage.detailDialog.unknownPoint")},[O.groups,W,E]),N=e.useMemo(()=>{if(!D?.logValue)return null;const e=e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e),a=e=>e.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()).trim(),t=(e,a)=>{if(null==a)return E("auditTrailPage.detailDialog.notApplicable");const t=e.toLowerCase();return"itemid"===t?S(a):"groupid"===t||"parentid"===t?V(a):"boolean"==typeof a?E(a?"common.yes":"common.no"):"object"==typeof a?JSON.stringify(a,null,2):String(a)};try{const i=JSON.parse(D.logValue);if(v.log("Parsed logValue:",i),void 0!==i.Old&&void 0!==i.New){const r=i.Old,d=i.New,l=new Set([...Object.keys(r||{}),...Object.keys(d||{})]),s=[];return l.forEach(i=>{const l=r?.[i],o=d?.[i],n=i.toLowerCase();if("itemid"!==n&&"groupid"!==n&&"parentid"!==n&&n.endsWith("id")&&("string"==typeof l&&e(l)||"string"==typeof o&&e(o)))return;const u=t(i,l),c=t(i,o),g=null==l,p=null==o,h=u!==c;(h||g||p)&&s.push({field:a(i),oldValue:u,newValue:c,isChanged:h,isAdded:g,isRemoved:p})}),s.length>0?s:null}const r=Object.keys(i),d=r.some(e=>e.endsWith("New")||e.endsWith("Old")),l=r.some(e=>e.startsWith("New")||e.startsWith("Old"));if(d||l){const d=new Set;r.forEach(e=>{e.endsWith("New")||e.endsWith("Old")?d.add(e.slice(0,-3)):(e.startsWith("New")||e.startsWith("Old"))&&d.add(e.slice(3))});const l=[];return d.forEach(d=>{const s=`${d}Old`,o=`${d}New`,n=`Old${d}`,u=`New${d}`,c=r.includes(s)?s:n,g=r.includes(o)?o:u,p=i[c],h=i[g],m=d.toLowerCase();if("itemid"!==m&&"groupid"!==m&&"parentid"!==m&&m.endsWith("id")&&("string"==typeof p&&e(p)||"string"==typeof h&&e(h)))return;const x=t(d,p),f=t(d,h),T=null==p,y=null==h,b=x!==f;(b||T||y)&&l.push({field:a(d),oldValue:x,newValue:f,isChanged:b,isAdded:T,isRemoved:y})}),l.length>0?l:null}const s=[];return Object.keys(i).forEach(r=>{const d=r.toLowerCase(),l="groupid"===d||"parentid"===d||"itemid"===d,o=i[r];!l&&d.endsWith("id")&&"string"==typeof o&&e(o)||s.push({field:a(r),oldValue:E("auditTrailPage.detailDialog.notApplicable"),newValue:t(r,o),isChanged:!1,isAdded:!0,isRemoved:!1})}),s.length>0?s:{raw:i}}catch(i){return v.warn("Failed to parse logValue as JSON:",i),{raw:D.logValue}}},[D?.logValue,E,S,V]);if(!D)return null;const $=N&&!("raw"in N);return a.jsxs(o,{open:r,onClose:k,maxWidth:"lg",fullWidth:!0,"data-id-ref":"audit-trail-detail-dialog",PaperProps:{sx:{minHeight:"500px"}},children:[a.jsx(n,{"data-id-ref":"audit-trail-detail-dialog-title",children:a.jsx(u,{variant:"h5",component:"div",children:E("auditTrailPage.detailDialog.title")})}),a.jsx(c,{"data-id-ref":"audit-trail-detail-dialog-content",dividers:!0,children:a.jsxs(g,{spacing:3,children:[a.jsxs(p,{"data-id-ref":"audit-detail-action-type",children:[a.jsxs(u,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:[E("auditTrailPage.columns.actionType"),":"]}),a.jsx(p,{sx:{mt:.5},children:a.jsx(h,{label:(e=>{switch(e){case d.EditPoint:return E("auditTrailPage.logTypes.EditPoint");case d.EditAlarm:return E("auditTrailPage.logTypes.EditAlarm");case d.Login:return E("auditTrailPage.logTypes.Login");case d.Logout:return E("auditTrailPage.logTypes.Logout");case d.EditGroup:return E("auditTrailPage.logTypes.EditGroup");case d.AddAlarm:return E("auditTrailPage.logTypes.AddAlarm");case d.DeleteAlarm:return E("auditTrailPage.logTypes.DeleteAlarm");case d.AddExternalAlarm:return E("auditTrailPage.logTypes.AddExternalAlarm");case d.DeleteExternalAlarm:return E("auditTrailPage.logTypes.DeleteExternalAlarm");case d.EditExternalAlarm:return E("auditTrailPage.logTypes.EditExternalAlarm");case d.AddPoint:return E("auditTrailPage.logTypes.AddPoint");case d.DeletePoint:return E("auditTrailPage.logTypes.DeletePoint");case d.DeleteGroup:return E("auditTrailPage.logTypes.DeleteGroup");case d.AddGroup:return E("auditTrailPage.logTypes.AddGroup");case d.EditUser:return E("auditTrailPage.logTypes.EditUser");case d.AddUser:return E("auditTrailPage.logTypes.AddUser");case d.DeleteUser:return E("auditTrailPage.logTypes.DeleteUser");case d.EditRole:return E("auditTrailPage.logTypes.EditRole");case d.AddRole:return E("auditTrailPage.logTypes.AddRole");case d.DeleteRole:return E("auditTrailPage.logTypes.DeleteRole");default:return`${E("auditTrailPage.detailDialog.unknown")} (${e})`}})(D.actionType),color:"primary",size:"medium","data-id-ref":"audit-detail-action-type-chip"})})]}),a.jsx(m,{}),a.jsxs(p,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)"},gap:3},children:[a.jsxs(p,{"data-id-ref":"audit-detail-user",children:[a.jsxs(u,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:[E("auditTrailPage.columns.userName"),":"]}),a.jsx(u,{variant:"body1",sx:{mt:.5},children:D.isUser?D.userName||E("auditTrailPage.detailDialog.unknownUser"):E("auditTrailPage.systemUser")})]}),a.jsxs(p,{"data-id-ref":"audit-detail-point",children:[a.jsxs(u,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:[E("auditTrailPage.columns.point"),":"]}),a.jsx(u,{variant:"body1",sx:{mt:.5},children:S(D.itemId)})]}),a.jsxs(p,{"data-id-ref":"audit-detail-datetime",children:[a.jsxs(u,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:[E("auditTrailPage.columns.dateTime"),":"]}),a.jsx(u,{variant:"body1",sx:{mt:.5},children:l(D.time,W,"long")})]}),D.ipAddress&&a.jsxs(p,{"data-id-ref":"audit-detail-ip",children:[a.jsxs(u,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:[E("auditTrailPage.columns.ipAddress"),":"]}),a.jsx(u,{variant:"body1",sx:{mt:.5},children:D.ipAddress})]})]}),a.jsx(m,{}),a.jsxs(p,{"data-id-ref":"audit-detail-changes",children:[a.jsxs(u,{variant:"h6",sx:{mb:2,fontWeight:600},children:[E($?"auditTrailPage.detailDialog.changesSection":"auditTrailPage.detailDialog.detailsSection"),":"]}),(()=>{if(!N)return a.jsx(u,{variant:"body2",color:"text.secondary",children:E("auditTrailPage.detailDialog.noDetails")});if("raw"in N){const e=N.raw;return"string"==typeof e?a.jsx(u,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:e}):a.jsx("pre",{style:{margin:0,padding:C.spacing(2),fontSize:"13px",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word",backgroundColor:"dark"===C.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",borderRadius:C.shape.borderRadius,maxHeight:"400px",overflow:"auto"},children:JSON.stringify(e,null,2)})}return a.jsx(T,{component:y,elevation:0,sx:{border:`1px solid ${C.palette.divider}`,borderRadius:1},"data-id-ref":"audit-changes-table",children:a.jsxs(b,{size:"small",children:[a.jsx(j,{children:a.jsxs(P,{children:[a.jsx(w,{sx:{fontWeight:600,backgroundColor:"dark"===C.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",width:"25%"},"data-id-ref":"audit-changes-header-field",children:E("auditTrailPage.detailDialog.field")}),a.jsx(w,{sx:{fontWeight:600,backgroundColor:"dark"===C.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",width:"37.5%"},"data-id-ref":"audit-changes-header-old",children:E("auditTrailPage.detailDialog.oldValue")}),a.jsx(w,{sx:{fontWeight:600,backgroundColor:"dark"===C.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",width:"37.5%"},"data-id-ref":"audit-changes-header-new",children:E("auditTrailPage.detailDialog.newValue")})]})}),a.jsx(A,{children:N.map((e,t)=>{let i="transparent";return e.isAdded?i="dark"===C.palette.mode?"rgba(76, 175, 80, 0.15)":"rgba(76, 175, 80, 0.08)":e.isRemoved?i="dark"===C.palette.mode?"rgba(244, 67, 54, 0.15)":"rgba(244, 67, 54, 0.08)":e.isChanged&&(i="dark"===C.palette.mode?"rgba(33, 150, 243, 0.15)":"rgba(33, 150, 243, 0.08)"),a.jsxs(P,{sx:{backgroundColor:i,"&:hover":{backgroundColor:"dark"===C.palette.mode?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.04)"}},"data-id-ref":`audit-change-row-${t}`,children:[a.jsx(w,{sx:{fontWeight:500,verticalAlign:"top",borderRight:`1px solid ${C.palette.divider}`},children:e.field}),a.jsx(w,{sx:{fontFamily:"monospace",fontSize:"13px",whiteSpace:"pre-wrap",wordBreak:"break-word",verticalAlign:"top",borderRight:`1px solid ${C.palette.divider}`,color:e.isAdded?C.palette.text.disabled:C.palette.text.primary},children:e.isAdded?a.jsx("em",{children:E("auditTrailPage.detailDialog.notApplicable")}):e.oldValue}),a.jsx(w,{sx:{fontFamily:"monospace",fontSize:"13px",whiteSpace:"pre-wrap",wordBreak:"break-word",verticalAlign:"top",color:e.isRemoved?C.palette.text.disabled:C.palette.text.primary},children:e.isRemoved?a.jsx("em",{children:E("auditTrailPage.detailDialog.notApplicable")}):e.newValue})]},t)})})]})})})()]})]})}),a.jsx(x,{"data-id-ref":"audit-trail-detail-dialog-actions",sx:{px:3,py:2},children:a.jsx(f,{onClick:k,variant:"contained","data-id-ref":"audit-trail-detail-close-btn",children:E("close")})})]})};export{k as A};
