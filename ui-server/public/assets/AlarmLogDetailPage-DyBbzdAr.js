import{bI as a,bQ as e}from"./vendor-TAwwu7tv.js";import{a as t,c as r,m as s,B as l}from"./layout-C1_h6sDC.js";import{S as i}from"./SeparatedDateTimePicker-Br7Be0Cr.js";import{SyncfusionGridWrapper as o}from"./SyncfusionGridWrapper-je9qfgPl.js";import{f as n}from"./dateFormatting-Oyh3Sj-d.js";import{u as d,d as c,x as m,B as g,q as u,a as f,I as x,a7 as h,r as p,a8 as y,v as j,j as D,c as w}from"./mui-core-im59jMHH.js";import{ac as v,ad as b,R as S,c as A,ae as I,W as $,af as L}from"./mui-icons-v3eeVnKX.js";import{c as F}from"./react-router-B0bL9ISA.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";const C=r(),E=()=>{const[r]=F(),E=r.get("itemId"),{t:M,language:k}=t(),P=d(),N=c(P.breakpoints.down("md")),[z,T]=a.useState(null),[W,H]=a.useState([]),[R,Z]=a.useState(!1),[B,O]=a.useState("last24Hours"),[U,q]=a.useState(""),[G,J]=a.useState(""),[Q,Y]=a.useState(N),[K,V]=a.useState(new Map),[X,_]=a.useState(new Map),aa=a.useRef(null),ea=a.useCallback((a,e)=>{if(!a||!e)return"";const t=a.compareType,r=a.value1||"",s=a.value2||"",l="fa"===k?e.unitFa||e.unit||"":e.unit||"";switch(t){case 1:return`${M("activeAlarmsPage.conditionEqual")} ${r} ${l}`;case 2:return`${M("activeAlarmsPage.conditionNotEqual")} ${r} ${l}`;case 3:return`${M("activeAlarmsPage.conditionHigher")} ${r} ${l}`;case 4:return`${M("activeAlarmsPage.conditionLower")} ${r} ${l}`;case 5:return`${M("activeAlarmsPage.conditionBetween")} ${r} ${M("and")} ${s} ${l}`;default:return""}},[k,M]);a.useEffect(()=>{(async()=>{try{C.log("Loading items and alarms from Zustand store");const[a,e]=await Promise.all([s.getStoredItems(),s.getStoredAlarms()]);if(a){const e=new Map;a.forEach(a=>{a.id&&e.set(a.id,a)}),V(e),C.log("Items loaded from Zustand store",{count:e.size})}if(e){C.log("Alarms data received from Zustand store",{isArray:Array.isArray(e),count:Array.isArray(e)?e.length:"N/A",hasDataProperty:"data"in e,sample:Array.isArray(e)&&e.length>0?e[0]:null});const a=Array.isArray(e)?e:e?.data;if(Array.isArray(a)){const e=new Map;a.forEach(a=>{a.id&&e.set(a.id,a)}),_(e),C.log("Alarms loaded from Zustand store",{count:e.size})}else C.warn("Alarms data is not in expected format",{type:typeof a})}else C.warn("No alarms found in Zustand store")}catch(a){C.error("Error loading data from Zustand store:",a)}})()},[]);const ta=a.useMemo(()=>{const a=Math.floor(Date.now()/1e3);let e,t=a;switch(B){case"last24Hours":default:e=a-86400;break;case"last7Days":e=a-604800;break;case"last30Days":e=a-2592e3;break;case"custom":U&&G?(e=Math.floor(new Date(U).getTime()/1e3),t=Math.floor(new Date(G).getTime()/1e3)):e=a-86400}return{startDate:e,endDate:t}},[B,U,G]),ra=async()=>{T(null),Z(!0);try{const{startDate:a,endDate:e}=ta;if(a>=e)return T(M("invalidDateRange")),void Z(!1);const t={itemIds:E?[E]:[],startDate:a,endDate:e};C.log("Fetching alarm history for specific itemId",{itemId:E,startDate:a,endDate:e});const r=await l(t);H(r.data||[]),T(null),Z(!1),C.log("Alarm history data fetched successfully",{count:r.data?.length||0,startDate:a,endDate:e})}catch(a){C.error("Error fetching alarm history data:",a),T(M("errorLoadingData")),Z(!1)}};a.useEffect(()=>(C.log("⭐⭐⭐ AlarmLogDetailPage MOUNTED ⭐⭐⭐",{itemId:E}),ra(),()=>{C.log("❌❌❌ AlarmLogDetailPage UNMOUNTING ❌❌❌")}),[B,E]);const sa=a=>{const e=new Date(1e3*a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};a.useEffect(()=>{if("custom"===B&&!U&&!G){const{startDate:a,endDate:e}=ta;q(sa(a)),J(sa(e))}},[B,U,G,ta]);const la=a.useCallback(a=>{const t=a.isActive;return e.jsx(m,{label:M(t?"active":"inactive"),color:t?"error":"default",size:"small","data-id-ref":"alarm-status-chip-"+(t?"active":"inactive")})},[M]),ia=a.useMemo(()=>[{field:"itemName",headerText:M("activeAlarmsPage.itemName"),width:200,minWidth:150,allowSorting:!0,allowFiltering:!0},{field:"alarmLog",headerText:M("alarmMessage"),width:300,minWidth:200,allowSorting:!0,allowFiltering:!0},{field:"isActive",headerText:M("alarmStatus"),width:120,minWidth:100,allowSorting:!0,allowFiltering:!0,template:la},{field:"condition",headerText:M("activeAlarmsPage.condition"),width:200,minWidth:150,allowSorting:!0,allowFiltering:!0},{field:"timeFormatted",headerText:M("time"),width:180,minWidth:140,allowSorting:!0,allowFiltering:!0}],[M,la]),oa=a.useMemo(()=>W.map((a,e)=>{const t=n(a.time,k,"short"),r=a.itemId?K.get(a.itemId):void 0,s=a.alarmId?X.get(a.alarmId):void 0;let l="";if(s)l="fa"===k?s.messageFa||s.message||"":s.message||"","fa"===k&&!s.messageFa&&s.message&&C.warn("[AlarmLogDetailPage] Persian message (messageFa) not found for alarm, using English message",{alarmId:a.alarmId,englishMessage:s.message});else try{const e="string"==typeof a.alarmLog?JSON.parse(a.alarmLog):a.alarmLog;l=e?.Message||"","fa"===k&&C.warn("[AlarmLogDetailPage] Using fallback alarmLog Message (English only) because alarm config not found",{alarmId:a.alarmId,message:l})}catch(d){C.error("[AlarmLogDetailPage] Failed to parse alarmLog JSON",{alarmLog:a.alarmLog,error:d}),l=""}const i=r?"fa"===k&&r.nameFa?r.nameFa:r.name:a.itemId||"",o=ea(s,r);return{id:a.id||`alarm-${e}`,itemName:i,alarmLog:l,isActive:a.isActive,condition:o,timeFormatted:t,time:a.time}}),[W,K,X,k,ea]);return e.jsxs(g,{sx:{height:"100%",display:"flex",flexDirection:"column",p:3,overflow:"auto"},"data-id-ref":"alarm-log-detail-page-container",children:[e.jsxs(u,{"data-id-ref":"alarm-log-detail-date-range-card",sx:{mb:3},children:[e.jsxs(g,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1.5,borderBottom:1,borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle1",fontWeight:"bold","data-id-ref":"alarm-log-detail-date-range-title",children:M("dateRange")}),N&&e.jsx(x,{size:"small",onClick:()=>Y(a=>!a),"aria-expanded":!Q,"data-id-ref":"alarm-log-detail-date-range-collapse-button",children:Q?e.jsx(v,{}):e.jsx(b,{})})]}),e.jsx(h,{in:!N||!Q,children:e.jsx(p,{sx:{p:N?2:3},"data-id-ref":"alarm-log-detail-date-range-card-body",children:e.jsxs(g,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"flex-end"},gap:2},children:[e.jsxs(y,{variant:"outlined",size:"small",sx:{flexWrap:"wrap"},"data-id-ref":"alarm-log-detail-date-range-preset-buttons",children:[e.jsx(j,{variant:"last24Hours"===B?"contained":"outlined",onClick:()=>O("last24Hours"),"data-id-ref":"alarm-log-detail-preset-last-24-hours",children:M("last24Hours")}),e.jsx(j,{variant:"last7Days"===B?"contained":"outlined",onClick:()=>O("last7Days"),"data-id-ref":"alarm-log-detail-preset-last-7-days",children:M("last7Days")}),e.jsx(j,{variant:"last30Days"===B?"contained":"outlined",onClick:()=>O("last30Days"),"data-id-ref":"alarm-log-detail-preset-last-30-days",children:M("last30Days")}),e.jsx(j,{variant:"custom"===B?"contained":"outlined",onClick:()=>O("custom"),"data-id-ref":"alarm-log-detail-preset-custom",children:M("customRange")})]}),"custom"===B&&e.jsxs(e.Fragment,{children:[e.jsx(i,{id:"alarm-log-detail-custom-start-date",value:U,onChange:q,"data-id-ref":"alarm-log-detail-custom-start-date",className:"",dateLabel:M("startDate"),timeLabel:M("startTime")}),e.jsx(i,{id:"alarm-log-detail-custom-end-date",value:G,onChange:J,"data-id-ref":"alarm-log-detail-custom-end-date",className:"",dateLabel:M("endDate"),timeLabel:M("endTime")})]}),e.jsx(j,{variant:"contained",color:"success",size:"small",onClick:ra,disabled:R,startIcon:R?e.jsx(D,{size:20}):e.jsx(S,{}),"data-id-ref":"alarm-log-detail-refresh-button",sx:{ml:{md:"auto"}},children:M("refresh")})]})})})]}),e.jsx(u,{"data-id-ref":"alarm-log-detail-data-grid-card",sx:{flex:1,display:"flex",flexDirection:"column"},children:e.jsxs(p,{sx:{flex:1,display:"flex",flexDirection:"column",p:N?2:3},children:[e.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,flexWrap:"wrap",gap:1},children:[e.jsxs(f,{variant:"h6","data-id-ref":"alarm-log-detail-grid-title",children:[M("alarmLog"),W.length>0&&e.jsx(m,{label:W.length,size:"small",color:"primary",sx:{ml:1},"data-id-ref":"alarm-log-detail-count-chip"})]}),e.jsxs(y,{variant:"outlined",size:"small","data-id-ref":"alarm-log-detail-export-buttons",children:[e.jsx(j,{onClick:()=>aa.current?.csvExport({fileName:`alarm-log-${Date.now()}.csv`}),disabled:R||0===W.length,startIcon:e.jsx(A,{}),"data-id-ref":"alarm-log-detail-export-csv-button",children:M("exportCsv")}),e.jsx(j,{onClick:()=>aa.current?.excelExport({fileName:`alarm-log-${Date.now()}.xlsx`}),disabled:R||0===W.length,startIcon:e.jsx(I,{}),"data-id-ref":"alarm-log-detail-export-excel-button",children:M("exportExcel")})]})]}),z&&e.jsx(w,{severity:"error",icon:e.jsx($,{}),onClose:()=>T(null),sx:{mb:2},"data-id-ref":"alarm-log-detail-error-alert",children:z}),R&&e.jsxs(g,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:2},"data-id-ref":"alarm-log-detail-loading-state",children:[e.jsx(D,{size:60}),e.jsx(f,{variant:"body1",color:"text.secondary",children:M("loadingData")})]}),!R&&!z&&0===W.length&&e.jsxs(g,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:2},"data-id-ref":"alarm-log-detail-empty-state",children:[e.jsx(L,{sx:{fontSize:80,color:"text.secondary",opacity:.5}}),e.jsx(f,{variant:"h6",color:"text.secondary",children:M("noAlarmsFound")}),e.jsx(f,{variant:"body2",color:"text.secondary",children:M("tryDifferentDateRange")})]}),!R&&!z&&W.length>0&&e.jsx(g,{sx:{flex:1,minHeight:0},"data-id-ref":"alarm-log-detail-grid-container",children:e.jsx(o,{ref:aa,data:oa,columns:ia,height:"100%",allowPaging:!0,allowSorting:!0,allowFiltering:!0,allowResizing:!0,allowExcelExport:!0,pageSettings:{pageSize:N?20:50,pageSizes:[10,20,50,100]}})})]})})]})};export{E as default};
