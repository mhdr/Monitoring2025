import{bI as e,bQ as a}from"./vendor-TAwwu7tv.js";import{a as s,c as i,ak as t,i as n,al as d}from"./layout-C1_h6sDC.js";import{SyncfusionGridWrapper as r}from"./SyncfusionGridWrapper-je9qfgPl.js";import{c as l,M as o,d as m,I as p}from"./api-D5q9v5qU.js";import{x as u,B as g,h as c,I as b,z as y,E as x,a as h,F as w,c as f,j,w as v,ac as G,t as M,J as R,K as I,N as C,b as T,v as E,O as S}from"./mui-core-im59jMHH.js";import{E as A,G as F,C as N,a8 as k,aA as z,aw as D}from"./mui-icons-v3eeVnKX.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./react-router-B0bL9ISA.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";const W=i(),B=e=>{const a=e.itemType===p.DigitalInput||e.itemType===p.DigitalOutput,s=e.itemType===p.DigitalOutput||e.itemType===p.AnalogOutput;let i;i=a?s?m.Coil:m.DiscreteInput:s?m.HoldingRegister:m.InputRegister;const t=a?o.Int16:o.Float32,n=a?l.None:l.BigEndian;return{modbusAddress:e.pointNumber,registerType:i,dataRepresentation:t,endianness:n}},L=({open:i,gateway:L,onClose:O,onSuccess:H})=>{const{t:$,language:P}=s(),[J,K]=e.useState([]),[Q,V]=e.useState([]),[_,q]=e.useState(!1),[U,X]=e.useState(!1),[Y,Z]=e.useState(null),[ee,ae]=e.useState([]),[se,ie]=e.useState(!1),[te,ne]=e.useState(!1),[de,re]=e.useState({itemId:"",modbusAddress:0,registerType:m.HoldingRegister,dataRepresentation:o.Float32,endianness:l.BigEndian,scaleMin:0,scaleMax:100}),[le,oe]=e.useState(null),[me,pe]=e.useState({itemId:"",modbusAddress:0,registerType:m.HoldingRegister,dataRepresentation:o.Float32,endianness:l.BigEndian,scaleMin:0,scaleMax:100});e.useEffect(()=>{i&&(async()=>{try{const e=await n();if(e?.items){const a=e.items.filter(e=>e.itemType===p.DigitalInput||e.itemType===p.DigitalOutput||e.itemType===p.AnalogInput||e.itemType===p.AnalogOutput);V(a),W.log("Monitoring items fetched",{count:a.length})}}catch(e){W.error("Failed to fetch items",{error:e})}})()},[i]);const ue=e.useCallback(async()=>{if(L?.id){q(!0),Z(null),ae([]);try{W.log("Fetching gateway mappings",{gatewayId:L.id});const e=await t({gatewayId:L.id});e?.isSuccessful&&e.mappings?(K(e.mappings.map(e=>({...e,isNew:!1,isModified:!1,isDeleted:!1}))),W.log("Mappings fetched",{count:e.mappings.length})):Z(e?.errorMessage||$("modbusGateway.errors.fetchMappingsFailed"))}catch(e){W.error("Failed to fetch mappings",{error:e}),Z($("modbusGateway.errors.fetchMappingsFailed"))}finally{q(!1)}}},[L?.id,$]);e.useEffect(()=>{i&&L?.id&&(ue(),ie(!1),ne(!1))},[i,L?.id,ue]);const ge=e.useCallback(e=>"fa"===P&&e.nameFa?e.nameFa:e.name,[P]),ce=e=>e===o.Float32?2:1,be=e.useCallback(e=>{switch(e){case m.Coil:return $("modbusGateway.registerTypes.coil");case m.DiscreteInput:return $("modbusGateway.registerTypes.discreteInput");case m.HoldingRegister:return $("modbusGateway.registerTypes.holdingRegister");case m.InputRegister:return $("modbusGateway.registerTypes.inputRegister");default:return String(e)}},[$]),ye=e.useCallback(e=>{switch(e){case o.Int16:return $("modbusGateway.dataRepresentations.int16");case o.Float32:return $("modbusGateway.dataRepresentations.float32");case o.ScaledInteger:return $("modbusGateway.dataRepresentations.scaledInteger");default:return String(e)}},[$]),xe=e.useCallback(e=>{switch(e){case l.None:return $("modbusGateway.endianness.none");case l.BigEndian:return $("modbusGateway.endianness.bigEndian");case l.LittleEndian:return $("modbusGateway.endianness.littleEndian");case l.MidBigEndian:return $("modbusGateway.endianness.midBigEndian");case l.MidLittleEndian:return $("modbusGateway.endianness.midLittleEndian");default:return String(e)}},[$]),he=e.useCallback(e=>{e.isNew?K(a=>a.filter(a=>a.id!==e.id)):K(a=>a.map(a=>a.id===e.id?{...a,isDeleted:!0}:a)),ie(!0)},[]),we=e.useCallback(e=>{oe(e),pe({itemId:e.itemId,modbusAddress:e.modbusAddress,registerType:e.registerType,dataRepresentation:e.dataRepresentation,endianness:e.endianness,scaleMin:e.scaleMin??0,scaleMax:e.scaleMax??100}),ne(!1)},[]),fe=e.useCallback(()=>{if(!le)return;const e={...le,modbusAddress:me.modbusAddress,registerType:me.registerType,dataRepresentation:me.dataRepresentation,endianness:me.endianness,registerCount:ce(me.dataRepresentation),scaleMin:me.dataRepresentation===o.ScaledInteger?""===me.scaleMin?0:me.scaleMin:null,scaleMax:me.dataRepresentation===o.ScaledInteger?""===me.scaleMax?100:me.scaleMax:null,isModified:!le.isNew};K(a=>a.map(a=>a.id===le.id?e:a)),ie(!0),oe(null)},[le,me]),je=e.useCallback(()=>{oe(null)},[]),ve=e.useMemo(()=>J.filter(e=>!e.isDeleted),[J]),Ge=e.useCallback(e=>{const s=e;return a.jsx(u,{"data-id-ref":`mapping-editable-chip-${s.id}`,label:s.isEditable?$("common.yes"):$("common.no"),color:s.isEditable?"success":"default",size:"small",variant:"outlined"})},[$]),Me=e.useCallback(e=>{const s=e;return a.jsxs(g,{"data-id-ref":`mapping-actions-${s.id}`,sx:{display:"flex",gap:.5,py:.5},children:[a.jsx(c,{title:$("edit"),children:a.jsx(b,{"data-id-ref":`mapping-edit-btn-${s.id}`,size:"small",color:"primary",onClick:()=>we(s),children:a.jsx(A,{fontSize:"small"})})}),a.jsx(c,{title:$("delete"),children:a.jsx(b,{"data-id-ref":`mapping-delete-btn-${s.id}`,size:"small",color:"error",onClick:()=>he(s),children:a.jsx(F,{fontSize:"small"})})})]})},[$,he,we]),Re=e.useMemo(()=>ve.map(e=>({...e,registerTypeName:be(e.registerType),itemDisplay:"fa"===P&&e.itemNameFa?e.itemNameFa:e.itemName||e.itemId||"",dataRepName:ye(e.dataRepresentation),endiannessName:xe(e.endianness)})),[ve,P,be,ye,xe]),Ie=e.useMemo(()=>[{field:"modbusAddress",headerText:$("modbusGateway.mappings.modbusAddress"),width:130,minWidth:100,allowSorting:!0},{field:"registerTypeName",headerText:$("modbusGateway.mappings.registerType"),width:160,minWidth:140,allowSorting:!0},{field:"itemDisplay",headerText:$("modbusGateway.mappings.item"),width:200,minWidth:150,allowSorting:!0},{field:"dataRepName",headerText:$("modbusGateway.mappings.dataRepresentation"),width:160,minWidth:140,allowSorting:!0},{field:"endiannessName",headerText:$("modbusGateway.mappings.endianness"),width:160,minWidth:140,allowSorting:!0},{field:"registerCount",headerText:$("modbusGateway.mappings.registerCount"),width:100,minWidth:80,allowSorting:!0},{field:"isEditable",headerText:$("modbusGateway.mappings.isEditable"),width:100,minWidth:80,template:Ge},{field:"id",headerText:$("common.actions"),width:110,minWidth:110,allowSorting:!1,allowFiltering:!1,template:Me}],[$,Ge,Me]),Ce=e.useMemo(()=>{const e=new Set(ve.map(e=>e.itemId));return Q.filter(a=>!e.has(a.id))},[Q,ve]),Te=e.useCallback(()=>{if(0===Ce.length)return;const e=Ce.map((e,a)=>{const s=B(e),i=s.dataRepresentation;return{id:`new-${Date.now()}-${a}`,gatewayId:L.id,modbusAddress:s.modbusAddress??e.pointNumber,registerType:s.registerType??m.HoldingRegister,itemId:e.id,itemName:e.name,itemNameFa:e.nameFa||null,isEditable:e.isEditable,registerCount:ce(i),dataRepresentation:i,endianness:s.endianness??l.BigEndian,scaleMin:null,scaleMax:null,isNew:!0,isModified:!1,isDeleted:!1}});K(a=>[...a,...e]),ie(!0),ne(!1)},[Ce,L.id]);return a.jsxs(y,{open:i,onClose:()=>{O()},maxWidth:"lg",fullWidth:!0,"data-id-ref":"modbus-gateway-mappings-dialog",children:[a.jsxs(x,{"data-id-ref":"modbus-gateway-mappings-dialog-title",sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[a.jsxs(g,{children:[a.jsx(h,{variant:"h6",children:$("modbusGateway.mappings.title")}),a.jsx(h,{variant:"body2",color:"text.secondary",children:$("modbusGateway.mappings.subtitle",{name:L.name})})]}),a.jsx(b,{"data-id-ref":"mappings-dialog-close-btn",onClick:O,edge:"end",children:a.jsx(N,{})})]}),a.jsxs(w,{"data-id-ref":"modbus-gateway-mappings-dialog-content",children:[Y&&a.jsx(f,{severity:"error",onClose:()=>Z(null),sx:{mb:2},"data-id-ref":"mappings-error-alert",children:Y}),ee.length>0&&a.jsx(f,{severity:"error",sx:{mb:2},"data-id-ref":"mappings-validation-errors",children:a.jsx("ul",{style:{margin:0,paddingLeft:20},children:ee.map((e,s)=>a.jsx("li",{children:"ADDRESS_OVERLAP"===e.errorCode?$("modbusGateway.validation.addressOverlap"):e.message},s))})}),_?a.jsx(g,{"data-id-ref":"mappings-loading",sx:{display:"flex",justifyContent:"center",py:4},children:a.jsx(j,{})}):a.jsxs(a.Fragment,{children:[te&&a.jsxs(g,{"data-id-ref":"add-mapping-form",sx:{mb:2,p:2,border:1,borderColor:"divider",borderRadius:1,backgroundColor:"background.default"},children:[a.jsx(h,{variant:"subtitle2",sx:{mb:2},children:$("modbusGateway.mappings.addMapping")}),a.jsxs(v,{direction:{xs:"column",md:"row"},spacing:2,flexWrap:"wrap",children:[a.jsx(G,{"data-id-ref":"add-mapping-item-autocomplete",options:Ce,getOptionLabel:e=>ge(e),value:Ce.find(e=>e.id===de.itemId)||null,onChange:(e,a)=>{if(a){const e=B(a);re(s=>({...s,itemId:a.id,modbusAddress:e.modbusAddress??s.modbusAddress,registerType:e.registerType??s.registerType,dataRepresentation:e.dataRepresentation??s.dataRepresentation,endianness:e.endianness??s.endianness}))}else re(e=>({...e,itemId:""}))},renderInput:e=>a.jsx(M,{...e,label:$("modbusGateway.mappings.item"),size:"small",sx:{minWidth:200}}),sx:{flex:2,minWidth:200}}),a.jsx(M,{"data-id-ref":"add-mapping-address-input",label:$("modbusGateway.mappings.modbusAddress"),type:"number",size:"small",value:de.modbusAddress,onChange:e=>re(a=>({...a,modbusAddress:Number(e.target.value)})),inputProps:{min:0},sx:{width:120}}),a.jsxs(R,{size:"small",sx:{minWidth:180},children:[a.jsx(I,{children:$("modbusGateway.mappings.registerType")}),a.jsxs(C,{"data-id-ref":"add-mapping-regtype-select",value:de.registerType,label:$("modbusGateway.mappings.registerType"),onChange:e=>re(a=>({...a,registerType:e.target.value})),children:[a.jsx(T,{value:m.Coil,children:$("modbusGateway.registerTypes.coil")}),a.jsx(T,{value:m.DiscreteInput,children:$("modbusGateway.registerTypes.discreteInput")}),a.jsx(T,{value:m.HoldingRegister,children:$("modbusGateway.registerTypes.holdingRegister")}),a.jsx(T,{value:m.InputRegister,children:$("modbusGateway.registerTypes.inputRegister")})]})]}),a.jsxs(R,{size:"small",sx:{minWidth:180},children:[a.jsx(I,{children:$("modbusGateway.mappings.dataRepresentation")}),a.jsxs(C,{"data-id-ref":"add-mapping-datarep-select",value:de.dataRepresentation,label:$("modbusGateway.mappings.dataRepresentation"),onChange:e=>re(a=>({...a,dataRepresentation:e.target.value})),children:[a.jsx(T,{value:o.Int16,children:$("modbusGateway.dataRepresentations.int16")}),a.jsx(T,{value:o.Float32,children:$("modbusGateway.dataRepresentations.float32")}),a.jsx(T,{value:o.ScaledInteger,children:$("modbusGateway.dataRepresentations.scaledInteger")})]})]}),de.dataRepresentation===o.Float32&&a.jsxs(R,{size:"small",sx:{minWidth:180},children:[a.jsx(I,{children:$("modbusGateway.mappings.endianness")}),a.jsxs(C,{"data-id-ref":"add-mapping-endian-select",value:de.endianness,label:$("modbusGateway.mappings.endianness"),onChange:e=>re(a=>({...a,endianness:e.target.value})),children:[a.jsx(T,{value:l.BigEndian,children:$("modbusGateway.endianness.bigEndian")}),a.jsx(T,{value:l.LittleEndian,children:$("modbusGateway.endianness.littleEndian")}),a.jsx(T,{value:l.MidBigEndian,children:$("modbusGateway.endianness.midBigEndian")}),a.jsx(T,{value:l.MidLittleEndian,children:$("modbusGateway.endianness.midLittleEndian")})]})]}),de.dataRepresentation===o.ScaledInteger&&a.jsxs(a.Fragment,{children:[a.jsx(M,{"data-id-ref":"add-mapping-scalemin-input",label:$("modbusGateway.mappings.scaleMin"),type:"number",size:"small",value:de.scaleMin,onChange:e=>re(a=>({...a,scaleMin:""===e.target.value?"":Number(e.target.value)})),sx:{width:100}}),a.jsx(M,{"data-id-ref":"add-mapping-scalemax-input",label:$("modbusGateway.mappings.scaleMax"),type:"number",size:"small",value:de.scaleMax,onChange:e=>re(a=>({...a,scaleMax:""===e.target.value?"":Number(e.target.value)})),sx:{width:100}})]}),a.jsx(E,{"data-id-ref":"add-mapping-confirm-btn",variant:"contained",size:"small",onClick:()=>{if(!de.itemId)return;const e=Q.find(e=>e.id===de.itemId),a={id:`new-${Date.now()}`,gatewayId:L.id,modbusAddress:de.modbusAddress,registerType:de.registerType,itemId:de.itemId,itemName:e?.name||null,itemNameFa:e?.nameFa||null,isEditable:e?.isEditable||!1,registerCount:ce(de.dataRepresentation),dataRepresentation:de.dataRepresentation,endianness:de.endianness,scaleMin:de.dataRepresentation===o.ScaledInteger?""===de.scaleMin?0:de.scaleMin:null,scaleMax:de.dataRepresentation===o.ScaledInteger?""===de.scaleMax?100:de.scaleMax:null,isNew:!0,isModified:!1,isDeleted:!1};K(e=>[...e,a]),ie(!0),ne(!1),re({itemId:"",modbusAddress:0,registerType:m.HoldingRegister,dataRepresentation:o.Float32,endianness:l.BigEndian,scaleMin:0,scaleMax:100})},disabled:!de.itemId,sx:{height:40},children:$("add")}),a.jsx(E,{"data-id-ref":"add-mapping-cancel-btn",variant:"outlined",size:"small",onClick:()=>ne(!1),sx:{height:40},children:$("cancel")})]})]}),le&&a.jsxs(g,{"data-id-ref":"edit-mapping-form",sx:{mb:2,p:2,border:1,borderColor:"primary.main",borderRadius:1,backgroundColor:"action.hover"},children:[a.jsxs(h,{variant:"subtitle2",sx:{mb:2},children:[$("modbusGateway.mappings.editMapping")," - ","fa"===P&&le.itemNameFa?le.itemNameFa:le.itemName]}),a.jsxs(v,{direction:{xs:"column",md:"row"},spacing:2,flexWrap:"wrap",children:[a.jsx(M,{"data-id-ref":"edit-mapping-address-input",label:$("modbusGateway.mappings.modbusAddress"),type:"number",size:"small",value:me.modbusAddress,onChange:e=>pe(a=>({...a,modbusAddress:Number(e.target.value)})),inputProps:{min:0},sx:{width:120}}),a.jsxs(R,{size:"small",sx:{minWidth:180},children:[a.jsx(I,{children:$("modbusGateway.mappings.registerType")}),a.jsxs(C,{"data-id-ref":"edit-mapping-regtype-select",value:me.registerType,label:$("modbusGateway.mappings.registerType"),onChange:e=>pe(a=>({...a,registerType:e.target.value})),children:[a.jsx(T,{value:m.Coil,children:$("modbusGateway.registerTypes.coil")}),a.jsx(T,{value:m.DiscreteInput,children:$("modbusGateway.registerTypes.discreteInput")}),a.jsx(T,{value:m.HoldingRegister,children:$("modbusGateway.registerTypes.holdingRegister")}),a.jsx(T,{value:m.InputRegister,children:$("modbusGateway.registerTypes.inputRegister")})]})]}),a.jsxs(R,{size:"small",sx:{minWidth:180},children:[a.jsx(I,{children:$("modbusGateway.mappings.dataRepresentation")}),a.jsxs(C,{"data-id-ref":"edit-mapping-datarep-select",value:me.dataRepresentation,label:$("modbusGateway.mappings.dataRepresentation"),onChange:e=>pe(a=>({...a,dataRepresentation:e.target.value})),children:[a.jsx(T,{value:o.Int16,children:$("modbusGateway.dataRepresentations.int16")}),a.jsx(T,{value:o.Float32,children:$("modbusGateway.dataRepresentations.float32")}),a.jsx(T,{value:o.ScaledInteger,children:$("modbusGateway.dataRepresentations.scaledInteger")})]})]}),me.dataRepresentation===o.Float32&&a.jsxs(R,{size:"small",sx:{minWidth:180},children:[a.jsx(I,{children:$("modbusGateway.mappings.endianness")}),a.jsxs(C,{"data-id-ref":"edit-mapping-endian-select",value:me.endianness,label:$("modbusGateway.mappings.endianness"),onChange:e=>pe(a=>({...a,endianness:e.target.value})),children:[a.jsx(T,{value:l.BigEndian,children:$("modbusGateway.endianness.bigEndian")}),a.jsx(T,{value:l.LittleEndian,children:$("modbusGateway.endianness.littleEndian")}),a.jsx(T,{value:l.MidBigEndian,children:$("modbusGateway.endianness.midBigEndian")}),a.jsx(T,{value:l.MidLittleEndian,children:$("modbusGateway.endianness.midLittleEndian")})]})]}),me.dataRepresentation===o.ScaledInteger&&a.jsxs(a.Fragment,{children:[a.jsx(M,{"data-id-ref":"edit-mapping-scalemin-input",label:$("modbusGateway.mappings.scaleMin"),type:"number",size:"small",value:me.scaleMin,onChange:e=>pe(a=>({...a,scaleMin:""===e.target.value?"":Number(e.target.value)})),sx:{width:100}}),a.jsx(M,{"data-id-ref":"edit-mapping-scalemax-input",label:$("modbusGateway.mappings.scaleMax"),type:"number",size:"small",value:me.scaleMax,onChange:e=>pe(a=>({...a,scaleMax:""===e.target.value?"":Number(e.target.value)})),sx:{width:100}})]}),a.jsx(E,{"data-id-ref":"edit-mapping-save-btn",variant:"contained",size:"small",onClick:fe,sx:{height:40},children:$("save")}),a.jsx(E,{"data-id-ref":"edit-mapping-cancel-btn",variant:"outlined",size:"small",onClick:je,sx:{height:40},children:$("cancel")})]})]}),a.jsxs(g,{"data-id-ref":"mappings-toolbar",sx:{display:"flex",gap:1,mb:2,alignItems:"center"},children:[a.jsx(E,{"data-id-ref":"mappings-add-btn",variant:"outlined",startIcon:a.jsx(k,{}),onClick:()=>ne(!0),disabled:te||U||!!le,children:$("modbusGateway.mappings.addMapping")}),a.jsx(c,{title:$("modbusGateway.mappings.addAllItemsTooltip"),children:a.jsx("span",{children:a.jsx(E,{"data-id-ref":"mappings-add-all-btn",variant:"outlined",color:"secondary",startIcon:a.jsx(z,{}),onClick:Te,disabled:te||U||0===Ce.length||!!le,children:$("modbusGateway.mappings.addAllItems")})})}),se&&a.jsx(u,{"data-id-ref":"mappings-unsaved-indicator",label:$("modbusGateway.mappings.unsavedChanges"),color:"warning",size:"small"})]}),0===ve.length?a.jsxs(g,{"data-id-ref":"mappings-empty-state",sx:{display:"flex",flexDirection:"column",alignItems:"center",py:8,textAlign:"center"},children:[a.jsx(h,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:$("modbusGateway.mappings.noMappings")}),a.jsx(h,{variant:"body2",color:"text.secondary",children:$("modbusGateway.mappings.addFirstMapping")})]}):a.jsx(g,{"data-id-ref":"mappings-grid-container",sx:{height:400},children:a.jsx(r,{data:Re,columns:Ie,height:"100%",allowPaging:!1,allowSorting:!0,allowResizing:!0,"data-id-ref":"gateway-mappings-grid"})})]})]}),a.jsxs(S,{"data-id-ref":"modbus-gateway-mappings-dialog-actions",children:[a.jsx(E,{"data-id-ref":"mappings-cancel-btn",onClick:O,disabled:U,children:$("close")}),a.jsx(E,{"data-id-ref":"mappings-save-btn",variant:"contained",startIcon:U?a.jsx(j,{size:20}):a.jsx(D,{}),onClick:async()=>{X(!0),Z(null),ae([]);try{const e=J.filter(e=>e.isNew&&!e.isDeleted).map(e=>({modbusAddress:e.modbusAddress,registerType:e.registerType,itemId:e.itemId,dataRepresentation:e.dataRepresentation,endianness:e.endianness,scaleMin:e.scaleMin,scaleMax:e.scaleMax})),a=J.filter(e=>e.isModified&&!e.isNew&&!e.isDeleted).map(e=>({id:e.id,modbusAddress:e.modbusAddress,registerType:e.registerType,itemId:e.itemId,dataRepresentation:e.dataRepresentation,endianness:e.endianness,scaleMin:e.scaleMin,scaleMax:e.scaleMax})),s=J.filter(e=>e.isDeleted&&!e.isNew).map(e=>e.id),i=await d({gatewayId:L.id,added:e,updated:a,removedIds:s});i.isSuccessful?(W.log("Mappings saved",{added:i.addedCount,updated:i.updatedCount,removed:i.removedCount}),H($("modbusGateway.success.mappingsSaved")),ie(!1),ue()):i.validationErrors&&i.validationErrors.length>0?ae(i.validationErrors):Z($("modbusGateway.errors.saveMappingsFailed"))}catch(e){W.error("Failed to save mappings",{error:e}),Z($("modbusGateway.errors.saveMappingsFailed"))}finally{X(!1)}},disabled:!se||U,children:$(U?"common.saving":"modbusGateway.mappings.saveChanges")})]})]})};export{L as default};
