import{bI as e,bQ as t}from"./vendor-TAwwu7tv.js";import{a,e as i,c as n,Q as r}from"./layout-C1_h6sDC.js";import{f as o}from"./dateFormatting-Oyh3Sj-d.js";import{E as l}from"./EChartsWrapper-CXD6P99r.js";import{C as s}from"./CardHeader-m1cb-2SA.js";import{u as d,d as m,B as c,a as g,v as u,c as f,q as x,I as v,a7 as h,r as p,w as y,x as b,J as j,K as I,N as S,b as F}from"./mui-core-im59jMHH.js";import{W as C,ap as $,ac as A,aq as M,ar as w,m as z,G as E}from"./mui-icons-v3eeVnKX.js";import{c as N}from"./react-router-B0bL9ISA.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./echarts-DOIPydnp.js";const k=n(),D="live_monitoring_settings",T=[{value:1e3,label:"1s"},{value:2e3,label:"2s"},{value:4e3,label:"4s"},{value:5e3,label:"5s"},{value:1e4,label:"10s"}],P=[50,100,200,500],W=()=>{const{t:n,language:W}=a(),L=d(),[R]=N(),G=R.get("itemId"),H=m(L.breakpoints.down("md")),{state:J}=i(),O=J.items.find(e=>e.id===G),q=J.itemsLoading,[B,Q]=e.useState([]),[V,Z]=e.useState(!1),[_,K]=e.useState(4e3),[X,U]=e.useState(50),[Y,ee]=e.useState(null),[te,ae]=e.useState(!1),[ie,ne]=e.useState(!1),[re,oe]=e.useState(!0),le=e.useRef(null);e.useEffect(()=>{(()=>{try{const e=localStorage.getItem(D);if(e){const t=JSON.parse(e);K(t.pollingInterval),U(t.maxDataPoints),k.log("Loaded live monitoring settings from localStorage",t)}else k.log("No saved settings found, using defaults",{pollingInterval:4e3,maxDataPoints:50})}catch(e){k.error("Error loading settings from localStorage:",e)}finally{ne(!0)}})()},[]),e.useEffect(()=>{if(ie)try{const e={pollingInterval:_,maxDataPoints:X};localStorage.setItem(D,JSON.stringify(e)),k.log("Saved live monitoring settings to localStorage",e)}catch(e){k.error("Error saving settings to localStorage:",e)}},[_,X,ie]);const se=e.useMemo(()=>O?"fa"===W&&O.nameFa?O.nameFa:O.name:n("itemNotFoundInStore"),[O,q,W,n]),de=e.useMemo(()=>{const e=O;return e?"fa"===W&&e.unitFa?e.unitFa:e.unit??"":""},[O,W]),me=e.useCallback(async()=>{if(G){ae(!0),ee(null);try{const e={itemId:G},t=await r(e);if(t.value){const e=parseFloat(t.value.value||"0"),a={value:isNaN(e)?0:e,time:t.value.time};Q(e=>{const t=[...e,a];return t.length>X?t.slice(t.length-X):t}),k.log("Fetched live value",{itemId:G,value:a.value,time:a.time})}ae(!1)}catch(e){k.error("Error fetching live value:",e),ee(n("errorLoadingData")),ae(!1),Z(!1)}}else ee(n("itemNotFound"))},[G,X,n]),ce=e.useCallback(()=>{G&&(Z(!0),ee(null),me(),le.current=setInterval(me,_),k.log("Started live monitoring",{itemId:G,pollingInterval:_}))},[G,_,me]),ge=e.useCallback(()=>{Z(!1),le.current&&(clearInterval(le.current),le.current=null),k.log("Stopped live monitoring",{itemId:G})},[G]),ue=e.useCallback(()=>{Q([]),ee(null),k.log("Cleared live data",{itemId:G})},[G]);e.useEffect(()=>()=>{le.current&&(clearInterval(le.current),le.current=null,k.log("Cleaned up interval on unmount",{itemId:G}))},[G]),e.useEffect(()=>{V&&le.current&&(clearInterval(le.current),le.current=null,me(),le.current=setInterval(me,_),k.log("Polling interval updated",{itemId:G,pollingInterval:_}))},[_,V,me,G]);const fe=e.useMemo(()=>{const e="fa"===W,t=B.map(e=>{const t=o(e.time,W,"short");return t.split("، ")[1]||t.split(", ")[1]||t}),a=B.map(e=>e.value),i=B.length>0?B[B.length-1].value:null;return{title:H?void 0:{text:`${se} - ${n("liveMonitoring")}`,subtext:null!==i?`${n("currentValue")}: ${i} ${de}`:void 0,left:"center",textStyle:{fontSize:16,fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0},subtextStyle:{fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0}},tooltip:{trigger:"axis",formatter:e=>{if(Array.isArray(e)&&e.length>0){const t=e[0];let a=String(t.value);if("fa"===W){const e=["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"];a=a.replace(/\d/g,t=>e[parseInt(t)])}const i=de?` ${de}`:"";return`${n("time")}: ${t.axisValue}<br/>${n("value")}: ${a}${i}`}return""},textStyle:{fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0}},grid:{left:H?e?"8%":"4%":e?"15%":"10%",right:H?e?"4%":"8%":e?"10%":"15%",bottom:H?"8%":"15%",top:H?"8%":"20%",containLabel:!0},xAxis:{type:"category",data:t,axisLabel:{rotate:45,fontSize:10,fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0,interval:H?Math.max(0,Math.floor(t.length/Math.max(1,Math.min(6,t.length)))):t.length>50?Math.floor(t.length/20):t.length>20?Math.floor(t.length/10):0}},yAxis:{type:"value",name:de||void 0,nameLocation:de?"middle":void 0,nameGap:de?50:void 0,nameRotate:de?e?-90:90:void 0,nameTextStyle:{fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0},axisLabel:{fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0}},legend:{show:!1},series:[{name:n("value"),type:"line",data:a,smooth:!0,lineStyle:{color:L.palette.primary.main,width:2},itemStyle:{color:L.palette.primary.main},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:`${L.palette.primary.main}40`},{offset:1,color:`${L.palette.primary.main}10`}]}},label:{fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0}}],dataZoom:H?void 0:[{type:"inside",start:B.length>50?50:0,end:100},{type:"slider",start:B.length>50?50:0,end:100,height:30,bottom:10,textStyle:{fontFamily:"fa"===W?"iransansxv, iransansx, Tahoma, Arial, sans-serif":void 0}}],toolbox:H?void 0:{feature:{dataZoom:{yAxisIndex:"none",title:{zoom:n("zoom"),back:n("reset")}},restore:{title:n("reset")},saveAsImage:{title:n("export")}},right:e?"auto":20,left:e?20:"auto"}}},[B,W,n,de,se,H,L.palette.primary.main]);return G?t.jsxs(c,{sx:{height:"100%",display:"flex",flexDirection:"column",p:H?1:3,maxWidth:"100%"},"data-id-ref":"live-monitoring-page-container",children:[Y&&t.jsx(f,{severity:"error",onClose:()=>ee(null),sx:{mb:3},"data-id-ref":"live-monitoring-error-alert",children:Y}),t.jsxs(x,{sx:{mb:3},"data-id-ref":"live-monitoring-controls-card",children:[t.jsx(s,{title:n("liveMonitoring"),dataIdRef:"live-monitoring-controls-header",action:H?t.jsx(v,{onClick:()=>oe(!re),"aria-expanded":re,"aria-label":n(re?"collapse":"expand"),sx:{transform:re?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},"data-id-ref":"live-monitoring-controls-expand-button",children:t.jsx(A,{})}):void 0}),t.jsx(h,{in:!H||re,timeout:"auto",unmountOnExit:!0,children:t.jsx(p,{sx:{p:H?2:3},"data-id-ref":"live-monitoring-controls-card-body",children:t.jsxs(y,{direction:H?"column":"row",spacing:2,alignItems:H?"stretch":"center",children:[t.jsx(u,{variant:"contained",color:V?"error":"success",size:"medium",onClick:V?ge:ce,startIcon:V?t.jsx(M,{}):t.jsx(w,{}),sx:{minWidth:{xs:"100%",md:150}},"data-id-ref":"live-monitoring-toggle-button",children:n(V?"stopMonitoring":"startMonitoring")}),t.jsx(b,{icon:t.jsx(z,{}),label:n(V?"pollingActive":"pollingStopped"),color:V?"success":"default",size:"medium","data-id-ref":"live-monitoring-status-chip"}),t.jsxs(j,{size:"small",sx:{minWidth:{xs:"100%",md:120}},"data-id-ref":"live-monitoring-refresh-rate-form",children:[t.jsx(I,{id:"refresh-rate-label",children:n("refreshRate")}),t.jsx(S,{labelId:"refresh-rate-label",id:"refresh-rate-select",value:_,label:n("refreshRate"),onChange:e=>K(Number(e.target.value)),disabled:V,"data-id-ref":"live-monitoring-refresh-rate-select",children:T.map(e=>t.jsx(F,{value:e.value,"data-id-ref":`live-monitoring-refresh-rate-${e.value}`,children:e.label},e.value))})]}),t.jsxs(j,{size:"small",sx:{minWidth:{xs:"100%",md:150}},"data-id-ref":"live-monitoring-max-points-form",children:[t.jsx(I,{id:"max-points-label",children:n("maxDataPoints")}),t.jsx(S,{labelId:"max-points-label",id:"max-points-select",value:X,label:n("maxDataPoints"),onChange:e=>U(Number(e.target.value)),disabled:V,"data-id-ref":"live-monitoring-max-points-select",children:P.map(e=>t.jsx(F,{value:e,"data-id-ref":`live-monitoring-max-points-${e}`,children:e},e))})]}),t.jsx(u,{variant:"outlined",color:"warning",size:"medium",onClick:ue,disabled:V||0===B.length,startIcon:t.jsx(E,{}),sx:{minWidth:{xs:"100%",md:"auto"},ml:{md:"auto"}},"data-id-ref":"live-monitoring-clear-button",children:n("clearData")})]})})})]}),t.jsxs(x,{sx:{flexGrow:1,display:"flex",flexDirection:"column",minHeight:0},"data-id-ref":"live-monitoring-chart-card",children:[t.jsx(s,{title:se,action:B.length>0?t.jsx(b,{label:`${B.length} ${1===B.length?n("dataPoint"):n("dataPoints")}`,color:"secondary",size:"small","data-id-ref":"live-monitoring-data-count"}):void 0,dataIdRef:"live-monitoring-chart-header"}),t.jsx(p,{sx:{flexGrow:1,display:"flex",alignItems:"center",justifyContent:"center",minHeight:0,p:H?1:2},"data-id-ref":"live-monitoring-chart-card-body",children:t.jsx(l,{option:fe,loading:te&&0===B.length,error:Y,emptyMessage:n("noData"),height:"100%",width:"100%",dataIdRef:"live-monitoring-chart"})})]})]}):t.jsx(c,{sx:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:400,p:3},"data-id-ref":"live-monitoring-no-item-container",children:t.jsxs(c,{sx:{textAlign:"center"},"data-id-ref":"live-monitoring-no-item-content",children:[t.jsx(C,{sx:{fontSize:80,color:"warning.main",mb:3},"data-id-ref":"live-monitoring-no-item-icon"}),t.jsx(g,{variant:"h5",gutterBottom:!0,"data-id-ref":"live-monitoring-no-item-title",children:n("itemNotFound")}),t.jsx(g,{variant:"body1",color:"text.secondary",sx:{mb:4},"data-id-ref":"live-monitoring-no-item-description",children:"fa"===W?"برای مشاهده مانیتورینگ زنده، لطفاً از صفحه مانیتورینگ یک پوینت را انتخاب کنید.":"To view live monitoring, please select a monitoring item from the Monitoring page."}),t.jsx(u,{variant:"contained",color:"primary",href:"/dashboard/monitoring",startIcon:t.jsx($,{}),"data-id-ref":"live-monitoring-no-item-back-button",children:"fa"===W?"بازگشت به مانیتورینگ":"Go to Monitoring"})]})})};export{W as default};
