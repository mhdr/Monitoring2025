import{bI as e,bQ as i}from"./vendor-TAwwu7tv.js";import{a as s,c as a,ag as t,i as r,ah as n}from"./layout-C1_h6sDC.js";import{SyncfusionGridWrapper as o}from"./SyncfusionGridWrapper-je9qfgPl.js";import{b as l}from"./api-D5q9v5qU.js";import{B as p,h as d,I as m,z as c,E as h,a as g,F as u,c as x,v as f,w as b,t as j,J as C,K as y,N as v,b as w,j as I,O as T}from"./mui-core-im59jMHH.js";import{E as S,G as M,C as z,a8 as F}from"./mui-icons-v3eeVnKX.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./react-router-B0bL9ISA.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";const k=a(),R=({open:a,controller:R,onClose:W})=>{const{t:N}=s(),[B,D]=e.useState([]),[E,P]=e.useState([]),[q,A]=e.useState(!1),[H,$]=e.useState(null),[G,O]=e.useState(null),[J,K]=e.useState(!1),[Q,U]=e.useState(null),[L,V]=e.useState({position:"",bit:"",itemId:"",operationType:l.Read}),[X,Y]=e.useState({});e.useEffect(()=>{a&&(async()=>{try{const e=await r();if(e?.items){const i=e.items.filter(e=>2===e.interfaceType);P(i),k.log("Sharp7 items fetched",{count:i.length})}}catch(e){k.error("Failed to fetch items",{error:e})}})()},[a]);const Z=e.useCallback(async()=>{if(R?.id){A(!0),$(null);try{k.log("Fetching mappings",{controllerId:R.id});const e=await t({controllerId:R.id});e?.data&&(D(e.data),k.log("Mappings fetched",{count:e.data.length}))}catch(e){k.error("Failed to fetch mappings",{error:e}),$(N("sharp7Controllers.errors.fetchMappingsFailed"))}finally{A(!1)}}},[R?.id,N]);e.useEffect(()=>{a&&R?.id&&Z()},[a,R?.id,Z]);const _=()=>{K(!1),U(null),V({position:"",bit:"",itemId:"",operationType:l.Read}),Y({})},ee=()=>{const e={};return(""===L.position||L.position<0)&&(e.position=N("sharp7Controllers.validation.positionRequired")),""!==L.bit&&(L.bit<0||L.bit>7)&&(e.bit=N("sharp7Controllers.validation.bitRange")),L.itemId||(e.itemId=N("sharp7Controllers.validation.itemRequired")),B.find(e=>e.position===L.position&&(e.bit??null)===(""===L.bit?null:L.bit)&&e.id!==Q)&&(e.position=N("sharp7Controllers.validation.positionExists")),Y(e),0===Object.keys(e).length},ie=async e=>{if(R?.id&&confirm(N("sharp7Controllers.dialogs.deleteMappingConfirm"))){A(!0),$(null);try{const i=await n({controllerId:R.id,changed:[],added:[],removed:[e.id]});i.isSuccessful?(O(N("sharp7Controllers.success.mappingDeleted")),Z()):$(i.errorMessage||N("sharp7Controllers.errors.deleteMappingFailed"))}catch(i){k.error("Failed to delete mapping",{error:i}),$(N("sharp7Controllers.errors.deleteMappingFailed"))}finally{A(!1),setTimeout(()=>O(null),5e3)}}},se=e.useCallback(e=>i.jsxs(p,{"data-id-ref":`sharp7-mapping-actions-${e.id}`,sx:{display:"flex",gap:.5,py:.5},children:[i.jsx(d,{title:N("common.buttons.edit"),children:i.jsx(m,{"data-id-ref":`sharp7-mapping-edit-btn-${e.id}`,size:"small",color:"primary",onClick:()=>{return V({position:(i=e).position,bit:i.bit??"",itemId:i.itemId,operationType:i.operationType??l.Read}),Y({}),U(i.id),void K(!0);var i},children:i.jsx(S,{fontSize:"small"})})}),i.jsx(d,{title:N("common.buttons.delete"),children:i.jsx(m,{"data-id-ref":`sharp7-mapping-delete-btn-${e.id}`,size:"small",color:"error",onClick:()=>ie(e),children:i.jsx(M,{fontSize:"small"})})})]}),[N,ie]),ae=e.useMemo(()=>B.map(e=>{const i=E.find(i=>i.id===e.itemId);return{...e,bitDisplay:null!==e.bit&&void 0!==e.bit?String(e.bit):"-",itemName:i?.name||e.itemId||"",operationTypeName:e.operationType===l.Read?N("sharp7Controllers.mappings.read"):N("sharp7Controllers.mappings.write")}}),[B,E,N]),te=e.useMemo(()=>[{field:"position",headerText:N("sharp7Controllers.mappings.position"),width:100,minWidth:80,allowSorting:!0},{field:"bitDisplay",headerText:N("sharp7Controllers.mappings.bit"),width:80,minWidth:60,allowSorting:!0},{field:"itemName",headerText:N("sharp7Controllers.mappings.item"),width:200,minWidth:150,allowSorting:!0},{field:"operationTypeName",headerText:N("sharp7Controllers.mappings.operationType"),width:120,minWidth:100,allowSorting:!0},{field:"id",headerText:N("common.actions"),width:120,minWidth:120,allowSorting:!1,allowFiltering:!1,template:se}],[N,se]);return i.jsxs(c,{open:a,onClose:W,maxWidth:"md",fullWidth:!0,"data-id-ref":"sharp7-mappings-dialog",PaperProps:{sx:{height:{xs:"100%",sm:"80vh"},maxHeight:{xs:"100%",sm:"80vh"}}},children:[i.jsxs(h,{"data-id-ref":"sharp7-mappings-dialog-title",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pr:1},children:[i.jsxs(p,{children:[i.jsx(g,{variant:"h6",component:"span",children:N("sharp7Controllers.mappings.title")}),R&&i.jsxs(g,{variant:"subtitle2",color:"text.secondary",component:"div",children:[R.name," (",R.ipAddress," - DB",R.dbAddress,")"]})]}),i.jsx(m,{"data-id-ref":"sharp7-mappings-close-btn",onClick:W,size:"small",children:i.jsx(z,{})})]}),i.jsxs(u,{"data-id-ref":"sharp7-mappings-dialog-content",sx:{display:"flex",flexDirection:"column",p:2},children:[H&&i.jsx(x,{"data-id-ref":"sharp7-mappings-error",severity:"error",onClose:()=>$(null),sx:{mb:2},children:H}),G&&i.jsx(x,{"data-id-ref":"sharp7-mappings-success",severity:"success",onClose:()=>O(null),sx:{mb:2},children:G}),!J&&i.jsx(p,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:i.jsx(f,{"data-id-ref":"sharp7-add-mapping-btn",variant:"contained",size:"small",startIcon:i.jsx(F,{}),onClick:()=>{V({position:"",bit:"",itemId:"",operationType:l.Read}),Y({}),U(null),K(!0)},children:N("sharp7Controllers.mappings.addMapping")})}),J&&i.jsxs(p,{sx:{mb:2,p:2,border:1,borderColor:"divider",borderRadius:1},children:[i.jsx(g,{variant:"subtitle1",sx:{mb:2},children:N(Q?"sharp7Controllers.mappings.editMapping":"sharp7Controllers.mappings.addMapping")}),i.jsxs(b,{spacing:2,children:[i.jsxs(b,{direction:"row",spacing:2,children:[i.jsx(j,{"data-id-ref":"sharp7-mapping-position-input",label:N("sharp7Controllers.mappings.position"),type:"number",value:L.position,onChange:e=>V({...L,position:""===e.target.value?"":Number(e.target.value)}),error:Boolean(X.position),helperText:X.position,required:!0,size:"small",sx:{flex:1},inputProps:{min:0}}),i.jsx(j,{"data-id-ref":"sharp7-mapping-bit-input",label:N("sharp7Controllers.mappings.bit"),type:"number",value:L.bit,onChange:e=>V({...L,bit:""===e.target.value?"":Number(e.target.value)}),error:Boolean(X.bit),helperText:X.bit||N("sharp7Controllers.mappings.bitHelper"),size:"small",sx:{flex:1},inputProps:{min:0,max:7}})]}),i.jsxs(C,{fullWidth:!0,size:"small",error:Boolean(X.itemId),children:[i.jsx(y,{children:N("sharp7Controllers.mappings.item")}),i.jsx(v,{"data-id-ref":"sharp7-mapping-item-select",value:L.itemId,onChange:e=>V({...L,itemId:e.target.value}),label:N("sharp7Controllers.mappings.item"),children:E.map(e=>i.jsx(w,{value:e.id,children:e.name},e.id))})]}),i.jsxs(C,{fullWidth:!0,size:"small",children:[i.jsx(y,{children:N("sharp7Controllers.mappings.operationType")}),i.jsxs(v,{"data-id-ref":"sharp7-mapping-operation-select",value:L.operationType,onChange:e=>V({...L,operationType:Number(e.target.value)}),label:N("sharp7Controllers.mappings.operationType"),children:[i.jsx(w,{value:l.Read,children:N("sharp7Controllers.mappings.read")}),i.jsx(w,{value:l.Write,children:N("sharp7Controllers.mappings.write")})]})]}),i.jsxs(b,{direction:"row",spacing:1,justifyContent:"flex-end",children:[i.jsx(f,{"data-id-ref":"sharp7-mapping-cancel-btn",onClick:_,size:"small",children:N("common.buttons.cancel")}),i.jsx(f,{"data-id-ref":"sharp7-mapping-save-btn",variant:"contained",onClick:async()=>{if(ee()&&R?.id){A(!0),$(null);try{const e={id:Q||void 0,position:Number(L.position),bit:""===L.bit?null:Number(L.bit),itemId:L.itemId,operationType:L.operationType};if(Q){const i=await n({controllerId:R.id,changed:[e],added:[],removed:[]});i.isSuccessful?(O(N("sharp7Controllers.success.mappingUpdated")),_(),Z()):$(i.errorMessage||N("sharp7Controllers.errors.updateMappingFailed"))}else{const i=await n({controllerId:R.id,changed:[],added:[e],removed:[]});i.isSuccessful?(O(N("sharp7Controllers.success.mappingAdded")),_(),Z()):$(i.errorMessage||N("sharp7Controllers.errors.addMappingFailed"))}}catch(e){k.error("Failed to save mapping",{error:e}),$(N("sharp7Controllers.errors.saveMappingFailed"))}finally{A(!1),setTimeout(()=>O(null),5e3)}}},disabled:q,size:"small",children:N("common.buttons.save")})]})]})]}),q?i.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:i.jsx(I,{})}):0===B.length?i.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:i.jsx(g,{"data-id-ref":"sharp7-no-mappings",color:"text.secondary",children:N("sharp7Controllers.mappings.noMappings")})}):i.jsx(p,{sx:{flex:1,minHeight:300},children:i.jsx(o,{dataSource:ae,columns:te,height:"100%",allowPaging:!1,allowSorting:!0,allowResizing:!0,"data-id-ref":"sharp7-mappings-grid"})})]}),i.jsx(T,{"data-id-ref":"sharp7-mappings-dialog-actions",children:i.jsx(f,{"data-id-ref":"sharp7-mappings-close-action-btn",onClick:W,children:N("common.buttons.close")})})]})};export{R as default};
