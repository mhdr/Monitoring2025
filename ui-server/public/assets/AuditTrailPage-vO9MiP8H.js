import{bI as a,bQ as e,bH as t}from"./vendor-TAwwu7tv.js";import{a as i,c as l,C as r,D as d}from"./layout-C1_h6sDC.js";import{SyncfusionGridWrapper as s}from"./SyncfusionGridWrapper-je9qfgPl.js";import{A as n}from"./AuditTrailDetailDialog-BSyGuDx_.js";import{S as o}from"./SeparatedDateTimePicker-Br7Be0Cr.js";import{L as u}from"./api-D5q9v5qU.js";import{u as c,C as g,q as p,_ as m,a as x,r as f,B as h,a8 as T,v as y,w as j,J as P,K as b,N as w,b as D,t as S,c as C,j as v,a9 as k}from"./mui-core-im59jMHH.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./mui-icons-v3eeVnKX.js";import"./react-router-B0bL9ISA.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";import"./dateFormatting-Oyh3Sj-d.js";const A=l(),E=()=>{const{t:l}=i(),E=c(),L=a.useRef(null),[R,F]=a.useState("last7Days"),[$,I]=a.useState(""),[H,M]=a.useState(""),[G,N]=a.useState("all"),[z,U]=a.useState(""),[W,B]=a.useState([]),[V,J]=a.useState(!1),[O,q]=a.useState(null),[K,Q]=a.useState(1),[Y,_]=a.useState(50),[X,Z]=a.useState(0),[aa,ea]=a.useState(0),[ta,ia]=a.useState(null),[la,ra]=a.useState(!1),da=a.useMemo(()=>{const a=Math.floor(Date.now()/1e3);let e,t=a;switch(R){case"last24Hours":e=a-86400;break;case"last7Days":default:e=a-604800;break;case"last30Days":e=a-2592e3;break;case"custom":$&&H?(e=Math.floor(new Date($).getTime()/1e3),t=Math.floor(new Date(H).getTime()/1e3)):e=a-604800}return{startDate:e,endDate:t}},[R,$,H]),sa=a.useCallback(async()=>{try{J(!0),q(null);const{startDate:a,endDate:e}=da,t={startDate:a,endDate:e,itemId:z.trim()||null,page:K,pageSize:Y};A.log("Fetching audit logs:",t);const i=await r.post("/api/Monitoring/AuditLog",t);if(i.data?.data){const a=i.data.data;let e=a.data||[];"all"!==G&&(e=e.filter(a=>a.actionType===G)),B(e),Z(a.totalCount||0),ea(a.totalPages||0),Q(a.page||1),A.log(`Loaded ${e.length} audit logs (page ${a.page}/${a.totalPages}, total: ${a.totalCount})`)}}catch(a){A.error("Error fetching audit logs:",a),q(l("auditTrailPage.error")),d(a)}finally{J(!1)}},[da,z,K,Y,G,l]),na=a.useCallback(()=>{Q(1),sa()},[sa]),oa=a.useCallback(()=>{F("last7Days"),I(""),M(""),N("all"),U(""),Q(1)},[]),ua=a=>{F(a),"custom"!==a&&(I(""),M(""))},ca=a=>{const e=new Date(1e3*a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};a.useEffect(()=>{if("custom"===R&&!$&&!H){const{startDate:a,endDate:e}=da;I(ca(a)),M(ca(e))}},[R,$,H,da]);const ga=a.useCallback((a,e)=>{Q(e)},[]),pa=a.useCallback(a=>{_(Number(a.target.value)),Q(1)},[]),ma=a.useCallback(a=>{switch(a){case u.EditPoint:return l("auditTrailPage.logTypes.EditPoint");case u.EditAlarm:return l("auditTrailPage.logTypes.EditAlarm");case u.Login:return l("auditTrailPage.logTypes.Login");case u.Logout:return l("auditTrailPage.logTypes.Logout");case u.EditGroup:return l("auditTrailPage.logTypes.EditGroup");case u.AddAlarm:return l("auditTrailPage.logTypes.AddAlarm");case u.DeleteAlarm:return l("auditTrailPage.logTypes.DeleteAlarm");case u.AddExternalAlarm:return l("auditTrailPage.logTypes.AddExternalAlarm");case u.DeleteExternalAlarm:return l("auditTrailPage.logTypes.DeleteExternalAlarm");case u.EditExternalAlarm:return l("auditTrailPage.logTypes.EditExternalAlarm");case u.AddPoint:return l("auditTrailPage.logTypes.AddPoint");case u.DeletePoint:return l("auditTrailPage.logTypes.DeletePoint");case u.DeleteGroup:return l("auditTrailPage.logTypes.DeleteGroup");case u.AddGroup:return l("auditTrailPage.logTypes.AddGroup");case u.EditUser:return l("auditTrailPage.logTypes.EditUser");case u.AddUser:return l("auditTrailPage.logTypes.AddUser");case u.DeleteUser:return l("auditTrailPage.logTypes.DeleteUser");case u.EditRole:return l("auditTrailPage.logTypes.EditRole");case u.AddRole:return l("auditTrailPage.logTypes.AddRole");case u.DeleteRole:return l("auditTrailPage.logTypes.DeleteRole");default:return`Unknown (${a})`}},[l]),xa=a.useCallback(a=>{const t=a;if(!t.logValue)return"-";try{const a=JSON.parse(t.logValue);return e.jsx("pre",{style:{margin:0,padding:"8px",fontSize:"12px",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word",backgroundColor:"dark"===E.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",borderRadius:"4px",maxHeight:"300px",overflow:"auto"},children:JSON.stringify(a,null,2)})}catch{return e.jsx("pre",{style:{margin:0,padding:"8px",fontSize:"12px",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:t.logValue})}},[E.palette.mode]),fa=a.useMemo(()=>[{field:"userName",headerText:l("auditTrailPage.columns.userName"),width:180,allowSorting:!0,allowFiltering:!0},{field:"actionType",headerText:l("auditTrailPage.columns.actionType"),width:200,allowSorting:!0,allowFiltering:!0},{field:"itemId",headerText:l("auditTrailPage.columns.point"),width:280,allowSorting:!0},{field:"time",headerText:l("auditTrailPage.columns.dateTime"),width:250,allowSorting:!0,type:"number"},{field:"ipAddress",headerText:l("auditTrailPage.columns.ipAddress"),width:160,allowSorting:!0},{field:"logValue",headerText:l("auditTrailPage.columns.details"),width:300,minWidth:300,template:xa}],[l,xa]),ha=a.useCallback(a=>{const e=a;e.data&&(A.log("Row clicked:",e.data),ia(e.data),ra(!0))},[]),Ta=a.useCallback(()=>{ra(!1),ia(null)},[]);return a.useEffect(()=>{Q(1)},[R]),t.useEffect(()=>{K>0&&sa()},[K,Y,sa]),e.jsxs(g,{maxWidth:!1,"data-id-ref":"audit-trail-page-container",sx:{height:"100%",width:"100%",py:3,px:0,mx:0,display:"flex",flexDirection:"column"},children:[e.jsxs(p,{"data-id-ref":"audit-trail-page-card",sx:{height:"100%",display:"flex",flexDirection:"column",overflow:"auto"},children:[e.jsx(m,{"data-id-ref":"audit-trail-page-card-header",sx:{py:3,minHeight:80},title:e.jsx(x,{variant:"h4",component:"h1","data-id-ref":"audit-trail-page-title",children:l("auditTrailPage.title")})}),e.jsxs(f,{"data-id-ref":"audit-trail-page-card-body",sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",gap:2},children:[e.jsxs(h,{"data-id-ref":"audit-trail-filters",sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(h,{"data-id-ref":"audit-trail-date-range-section",children:[e.jsx(x,{variant:"subtitle2",sx:{mb:1},children:l("dateRange")}),e.jsxs(h,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"flex-end"},gap:2},children:[e.jsxs(T,{variant:"outlined",size:"small",sx:{flexWrap:"wrap"},"data-id-ref":"audit-trail-preset-button-group",children:[e.jsx(y,{variant:"last24Hours"===R?"contained":"outlined",onClick:()=>ua("last24Hours"),"data-id-ref":"audit-trail-preset-24h-button",children:l("last24Hours")}),e.jsx(y,{variant:"last7Days"===R?"contained":"outlined",onClick:()=>ua("last7Days"),"data-id-ref":"audit-trail-preset-7d-button",children:l("last7Days")}),e.jsx(y,{variant:"last30Days"===R?"contained":"outlined",onClick:()=>ua("last30Days"),"data-id-ref":"audit-trail-preset-30d-button",children:l("last30Days")}),e.jsx(y,{variant:"custom"===R?"contained":"outlined",onClick:()=>ua("custom"),"data-id-ref":"audit-trail-preset-custom-button",children:l("customRange")})]}),"custom"===R&&e.jsxs(e.Fragment,{children:[e.jsx(o,{id:"audit-trail-start",value:$,onChange:I,"data-id-ref":"audit-trail-start-datetime",className:"",dateLabel:l("startDate"),timeLabel:l("startTime")}),e.jsx(o,{id:"audit-trail-end",value:H,onChange:M,"data-id-ref":"audit-trail-end-datetime",className:"",dateLabel:l("endDate"),timeLabel:l("endTime")})]})]})]}),e.jsxs(j,{direction:{xs:"column",sm:"row"},spacing:2,"data-id-ref":"audit-trail-type-filters",children:[e.jsxs(P,{fullWidth:!0,"data-id-ref":"audit-trail-log-type-filter",children:[e.jsx(b,{children:l("auditTrailPage.logTypeLabel")}),e.jsxs(w,{value:G,label:l("auditTrailPage.logTypeLabel"),onChange:a=>N(a.target.value),children:[e.jsx(D,{value:"all","data-id-ref":"audit-trail-log-type-all",children:l("auditTrailPage.allLogTypes")}),Object.entries(u).map(([a,t])=>e.jsx(D,{value:t,"data-id-ref":`audit-trail-log-type-${a}`,children:ma(t)},t))]})]}),e.jsx(S,{label:l("auditTrailPage.itemIdLabel"),placeholder:l("auditTrailPage.itemIdPlaceholder"),value:z,onChange:a=>U(a.target.value),fullWidth:!0,"data-id-ref":"audit-trail-item-id-filter"})]}),e.jsxs(j,{direction:"row",spacing:2,"data-id-ref":"audit-trail-filter-buttons",children:[e.jsx(y,{variant:"contained",onClick:na,disabled:V,"data-id-ref":"audit-trail-apply-filters-btn",children:l("auditTrailPage.applyFilters")}),e.jsx(y,{variant:"outlined",onClick:oa,disabled:V,"data-id-ref":"audit-trail-clear-filters-btn",children:l("auditTrailPage.clearFilters")})]})]}),O&&e.jsx(C,{severity:"error","data-id-ref":"audit-trail-error-alert",onClose:()=>q(null),children:O}),V&&e.jsxs(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4},"data-id-ref":"audit-trail-loading",children:[e.jsx(v,{}),e.jsx(x,{sx:{ml:2},children:l("auditTrailPage.loadingData")})]}),!V&&e.jsx(h,{sx:{flex:1,minHeight:0},"data-id-ref":"audit-trail-grid-container",children:e.jsx(s,{idRef:"audit-trail-grid",data:W,columns:fa,onGridReady:a=>{L.current=a},onRecordClick:ha,height:"100%",allowPaging:!1,allowSorting:!0,allowFiltering:!0,allowResizing:!0})}),!V&&X>0&&e.jsxs(h,{"data-id-ref":"audit-trail-pagination",sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:"center",gap:2,pt:2,borderTop:`1px solid ${E.palette.divider}`},children:[e.jsxs(h,{sx:{display:"flex",alignItems:"center",gap:2},"data-id-ref":"audit-trail-pagination-info",children:[e.jsxs(P,{size:"small",sx:{minWidth:120},"data-id-ref":"audit-trail-page-size-select",children:[e.jsx(b,{children:l("auditTrailPage.pagination.rowsPerPage")}),e.jsxs(w,{value:Y,label:l("auditTrailPage.pagination.rowsPerPage"),onChange:pa,children:[e.jsx(D,{value:25,children:"25"}),e.jsx(D,{value:50,children:"50"}),e.jsx(D,{value:100,children:"100"}),e.jsx(D,{value:200,children:"200"})]})]}),e.jsx(x,{variant:"body2",color:"text.secondary","data-id-ref":"audit-trail-pagination-text",children:l("auditTrailPage.pagination.showing",{from:(K-1)*Y+1,to:Math.min(K*Y,X),total:X})})]}),e.jsx(k,{count:aa,page:K,onChange:ga,color:"primary",showFirstButton:!0,showLastButton:!0,siblingCount:1,boundaryCount:1,"data-id-ref":"audit-trail-pagination-component"})]}),!V&&0===W.length&&e.jsx(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:8},"data-id-ref":"audit-trail-no-data",children:e.jsx(x,{color:"text.secondary",children:l("auditTrailPage.noData")})})]})]}),e.jsx(n,{open:la,onClose:Ta,data:ta})]})};export{E as default};
