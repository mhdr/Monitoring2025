import{bI as a,bQ as e}from"./vendor-TAwwu7tv.js";import{a as t,e as i,c as l,C as r,D as d}from"./layout-C1_h6sDC.js";import{SyncfusionGridWrapper as s}from"./SyncfusionGridWrapper-je9qfgPl.js";import{A as n}from"./AuditTrailDetailDialog-BSyGuDx_.js";import{S as o}from"./SeparatedDateTimePicker-Br7Be0Cr.js";import{L as u}from"./api-D5q9v5qU.js";import{f as c}from"./dateFormatting-Oyh3Sj-d.js";import{u as g,C as p,q as m,_ as x,a as f,r as h,c as y,B as j,a8 as T,v as D,w,J as b,K as P,N as S,b as C,j as v,a9 as k}from"./mui-core-im59jMHH.js";import{c as A}from"./react-router-B0bL9ISA.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./mui-icons-v3eeVnKX.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";const E=l(),F=()=>{const[l]=A(),F=l.get("itemId"),{t:L,language:$}=t(),N=g(),{state:I}=i(),M=I.items,W=a.useMemo(()=>F?M.find(a=>a.id===F):null,[F,M]),[H,z]=a.useState("last7Days"),[R,B]=a.useState(""),[G,V]=a.useState(""),[J,O]=a.useState("all"),[U,q]=a.useState([]),[K,Q]=a.useState(!1),[Y,_]=a.useState(null),[X,Z]=a.useState(1),[aa,ea]=a.useState(50),[ta,ia]=a.useState(0),[la,ra]=a.useState(0),[da,sa]=a.useState(null),[na,oa]=a.useState(!1),ua=a.useMemo(()=>{const a=Math.floor(Date.now()/1e3);let e,t=a;switch(H){case"last24Hours":e=a-86400;break;case"last7Days":default:e=a-604800;break;case"last30Days":e=a-2592e3;break;case"custom":R&&G?(e=Math.floor(new Date(R).getTime()/1e3),t=Math.floor(new Date(G).getTime()/1e3)):e=a-604800}return{startDate:e,endDate:t}},[H,R,G]),ca=a.useCallback(async()=>{if(F)try{Q(!0),_(null);const{startDate:a,endDate:e}=ua,t={startDate:a,endDate:e,itemId:F,page:X,pageSize:aa};E.log("Fetching audit logs for itemId:",F,t);const i=await r.post("/api/Monitoring/AuditLog",t);if(i.data?.data){const a=i.data.data;let e=a.data||[];"all"!==J&&(e=e.filter(a=>a.actionType===J)),q(e),ia(a.totalCount||0),ra(a.totalPages||0),Z(a.page||1),E.log(`Loaded ${e.length} audit logs for item ${F} (page ${a.page}/${a.totalPages}, total: ${a.totalCount})`)}}catch(a){E.error("Error fetching audit logs:",a),_(L("auditTrailPage.error")),d(a)}finally{Q(!1)}else _(L("itemNotFound"))},[ua,F,X,aa,J,L]),ga=a.useCallback(()=>{Z(1),ca()},[ca]),pa=a.useCallback(()=>{z("last7Days"),B(""),V(""),O("all"),Z(1)},[]),ma=a=>{z(a),"custom"!==a&&(B(""),V(""))},xa=a=>{const e=new Date(1e3*a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};a.useEffect(()=>{if("custom"===H&&!R&&!G){const{startDate:a,endDate:e}=ua;B(xa(a)),V(xa(e))}},[H,R,G,ua]);const fa=a.useCallback((a,e)=>{Z(e)},[]),ha=a.useCallback(a=>{ea(Number(a.target.value)),Z(1)},[]),ya=a.useCallback(a=>{switch(a){case u.EditPoint:return L("auditTrailPage.logTypes.EditPoint");case u.EditAlarm:return L("auditTrailPage.logTypes.EditAlarm");case u.Login:return L("auditTrailPage.logTypes.Login");case u.Logout:return L("auditTrailPage.logTypes.Logout");case u.EditGroup:return L("auditTrailPage.logTypes.EditGroup");case u.AddAlarm:return L("auditTrailPage.logTypes.AddAlarm");case u.DeleteAlarm:return L("auditTrailPage.logTypes.DeleteAlarm");case u.AddExternalAlarm:return L("auditTrailPage.logTypes.AddExternalAlarm");case u.DeleteExternalAlarm:return L("auditTrailPage.logTypes.DeleteExternalAlarm");case u.EditExternalAlarm:return L("auditTrailPage.logTypes.EditExternalAlarm");case u.AddPoint:return L("auditTrailPage.logTypes.AddPoint");case u.DeletePoint:return L("auditTrailPage.logTypes.DeletePoint");case u.DeleteGroup:return L("auditTrailPage.logTypes.DeleteGroup");default:return`Unknown (${a})`}},[L]),ja=a.useCallback(a=>{const t=a;if(!t?.logValue)return"-";try{const a=JSON.parse(t.logValue);return e.jsx("pre",{style:{margin:0,padding:"8px",fontSize:"12px",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word",backgroundColor:"dark"===N.palette.mode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",borderRadius:"4px",maxHeight:"300px",overflow:"auto"},children:JSON.stringify(a,null,2)})}catch{return e.jsx("pre",{style:{margin:0,padding:"8px",fontSize:"12px",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:t.logValue})}},[N.palette.mode]),Ta=a.useMemo(()=>[{field:"userNameDisplay",headerText:L("auditTrailPage.columns.userName"),width:180,minWidth:150,allowSorting:!0,allowFiltering:!0},{field:"actionTypeDisplay",headerText:L("auditTrailPage.columns.actionType"),width:200,minWidth:150,allowSorting:!0,allowFiltering:!0},{field:"dateTimeDisplay",headerText:L("auditTrailPage.columns.dateTime"),width:250,minWidth:180,allowSorting:!0,allowFiltering:!0},{field:"ipAddressDisplay",headerText:L("auditTrailPage.columns.ipAddress"),width:160,minWidth:120,allowSorting:!0,allowFiltering:!0},{field:"logValue",headerText:L("auditTrailPage.columns.details"),width:300,minWidth:200,allowSorting:!1,allowFiltering:!0,template:ja}],[L,ja]),Da=a.useMemo(()=>U.map(a=>({...a,userNameDisplay:a.isUser?a.userName||"-":L("auditTrailPage.systemUser"),actionTypeDisplay:a.actionType?ya(a.actionType):"",dateTimeDisplay:a.time?c(a.time,$,"long"):"",ipAddressDisplay:a.ipAddress||"-"})),[U,L,$,ya]),wa=a.useRef(null),ba=a.useCallback(a=>{const e=a;e.data&&(E.log("Row selected:",e.data),sa(e.data),oa(!0))},[]),Pa=a.useCallback(()=>{oa(!1),sa(null)},[]);if(a.useEffect(()=>{Z(1)},[H]),a.useEffect(()=>{X>0&&F&&ca()},[X,aa,ca,F]),!F)return e.jsx(p,{maxWidth:!1,"data-id-ref":"audit-trail-detail-page-container",sx:{height:"100%",width:"100%",py:3,px:0,mx:0,display:"flex",flexDirection:"column"},children:e.jsxs(m,{"data-id-ref":"audit-trail-detail-page-card",sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsx(x,{"data-id-ref":"audit-trail-detail-page-card-header",sx:{py:3,minHeight:80},title:e.jsx(f,{variant:"h4",component:"h1","data-id-ref":"audit-trail-detail-page-title",children:L("auditTrailDetail")})}),e.jsx(h,{"data-id-ref":"audit-trail-detail-page-card-body",sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},children:e.jsx(y,{severity:"error","data-id-ref":"audit-trail-detail-no-itemid-alert",children:L("itemNotFound")})})]})});const Sa=W?"fa"===$&&W.nameFa||W.name:F;return e.jsxs(p,{maxWidth:!1,"data-id-ref":"audit-trail-detail-page-container",sx:{height:"100%",width:"100%",py:3,px:0,mx:0,display:"flex",flexDirection:"column"},children:[e.jsxs(m,{"data-id-ref":"audit-trail-detail-page-card",sx:{height:"100%",display:"flex",flexDirection:"column",overflow:"auto"},children:[e.jsx(x,{"data-id-ref":"audit-trail-detail-page-card-header",sx:{py:3,minHeight:80},title:e.jsxs(j,{"data-id-ref":"audit-trail-detail-page-title-box",children:[e.jsx(f,{variant:"h4",component:"h1","data-id-ref":"audit-trail-detail-page-title",children:L("auditTrailDetail")}),e.jsx(f,{variant:"subtitle1",color:"text.secondary","data-id-ref":"audit-trail-detail-page-subtitle",children:Sa})]})}),e.jsxs(h,{"data-id-ref":"audit-trail-detail-page-card-body",sx:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",gap:2},children:[e.jsxs(j,{"data-id-ref":"audit-trail-detail-filters",sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(j,{"data-id-ref":"audit-trail-detail-date-range-section",children:[e.jsx(f,{variant:"subtitle2",sx:{mb:1},children:L("dateRange")}),e.jsxs(j,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"flex-end"},gap:2},children:[e.jsxs(T,{variant:"outlined",size:"small",sx:{flexWrap:"wrap"},"data-id-ref":"audit-trail-detail-preset-button-group",children:[e.jsx(D,{variant:"last24Hours"===H?"contained":"outlined",onClick:()=>ma("last24Hours"),"data-id-ref":"audit-trail-detail-preset-24h-button",children:L("last24Hours")}),e.jsx(D,{variant:"last7Days"===H?"contained":"outlined",onClick:()=>ma("last7Days"),"data-id-ref":"audit-trail-detail-preset-7d-button",children:L("last7Days")}),e.jsx(D,{variant:"last30Days"===H?"contained":"outlined",onClick:()=>ma("last30Days"),"data-id-ref":"audit-trail-detail-preset-30d-button",children:L("last30Days")}),e.jsx(D,{variant:"custom"===H?"contained":"outlined",onClick:()=>ma("custom"),"data-id-ref":"audit-trail-detail-preset-custom-button",children:L("customRange")})]}),"custom"===H&&e.jsxs(e.Fragment,{children:[e.jsx(o,{id:"audit-trail-detail-start",value:R,onChange:B,"data-id-ref":"audit-trail-detail-start-datetime",className:"",dateLabel:L("startDate"),timeLabel:L("startTime")}),e.jsx(o,{id:"audit-trail-detail-end",value:G,onChange:V,"data-id-ref":"audit-trail-detail-end-datetime",className:"",dateLabel:L("endDate"),timeLabel:L("endTime")})]})]})]}),e.jsx(w,{direction:{xs:"column",sm:"row"},spacing:2,"data-id-ref":"audit-trail-detail-type-filters",children:e.jsxs(b,{fullWidth:!0,"data-id-ref":"audit-trail-detail-log-type-filter",children:[e.jsx(P,{children:L("auditTrailPage.logTypeLabel")}),e.jsxs(S,{value:J,label:L("auditTrailPage.logTypeLabel"),onChange:a=>O(a.target.value),children:[e.jsx(C,{value:"all","data-id-ref":"audit-trail-detail-log-type-all",children:L("auditTrailPage.allLogTypes")}),Object.entries(u).map(([a,t])=>e.jsx(C,{value:t,"data-id-ref":`audit-trail-detail-log-type-${a}`,children:ya(t)},t))]})]})}),e.jsxs(w,{direction:"row",spacing:2,"data-id-ref":"audit-trail-detail-filter-buttons",children:[e.jsx(D,{variant:"contained",onClick:ga,disabled:K,"data-id-ref":"audit-trail-detail-apply-filters-btn",children:L("auditTrailPage.applyFilters")}),e.jsx(D,{variant:"outlined",onClick:pa,disabled:K,"data-id-ref":"audit-trail-detail-clear-filters-btn",children:L("auditTrailPage.clearFilters")})]})]}),Y&&e.jsx(y,{severity:"error","data-id-ref":"audit-trail-detail-error-alert",onClose:()=>_(null),children:Y}),K&&e.jsxs(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4},"data-id-ref":"audit-trail-detail-loading",children:[e.jsx(v,{}),e.jsx(f,{sx:{ml:2},children:L("auditTrailPage.loadingData")})]}),!K&&e.jsx(j,{sx:{flex:1,minHeight:0},"data-id-ref":"audit-trail-detail-grid-container",children:e.jsx(s,{ref:wa,data:Da,columns:Ta,height:"100%",allowPaging:!1,allowSorting:!0,allowFiltering:!0,allowResizing:!0,allowExcelExport:!0,onRowSelected:ba})}),!K&&ta>0&&e.jsxs(j,{"data-id-ref":"audit-trail-detail-pagination",sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:"center",gap:2,pt:2,borderTop:`1px solid ${N.palette.divider}`},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2},"data-id-ref":"audit-trail-detail-pagination-info",children:[e.jsxs(b,{size:"small",sx:{minWidth:120},"data-id-ref":"audit-trail-detail-page-size-select",children:[e.jsx(P,{children:L("auditTrailPage.pagination.rowsPerPage")}),e.jsxs(S,{value:aa,label:L("auditTrailPage.pagination.rowsPerPage"),onChange:ha,children:[e.jsx(C,{value:25,children:"25"}),e.jsx(C,{value:50,children:"50"}),e.jsx(C,{value:100,children:"100"}),e.jsx(C,{value:200,children:"200"})]})]}),e.jsx(f,{variant:"body2",color:"text.secondary","data-id-ref":"audit-trail-detail-pagination-text",children:L("auditTrailPage.pagination.showing",{from:(X-1)*aa+1,to:Math.min(X*aa,ta),total:ta})})]}),e.jsx(k,{count:la,page:X,onChange:fa,color:"primary",showFirstButton:!0,showLastButton:!0,siblingCount:1,boundaryCount:1,"data-id-ref":"audit-trail-detail-pagination-component"})]}),!K&&0===U.length&&e.jsx(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:8},"data-id-ref":"audit-trail-detail-no-data",children:e.jsx(f,{color:"text.secondary",children:L("auditTrailPage.noData")})})]})]}),e.jsx(n,{open:na,onClose:Pa,data:da})]})};export{F as default};
