import{bI as a,bQ as e}from"./vendor-TAwwu7tv.js";import{a as t,B as r,c as s,m as l}from"./layout-C1_h6sDC.js";import{S as i}from"./SeparatedDateTimePicker-Br7Be0Cr.js";import{SyncfusionGridWrapper as o}from"./SyncfusionGridWrapper-je9qfgPl.js";import{f as n}from"./dateFormatting-Oyh3Sj-d.js";import{u as d,d as c,x as m,B as g,q as u,a as x,I as f,a7 as p,r as h,a8 as y,v as j,j as w,c as v,J as b,K as D,N as S,b as A,a9 as C}from"./mui-core-im59jMHH.js";import{ac as $,ad as I,R as P,c as F,ae as L,W as k,af as z}from"./mui-icons-v3eeVnKX.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./react-router-B0bL9ISA.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";const E=s(),M=()=>{const{t:s,language:M}=t(),T=d(),N=c(T.breakpoints.down("md")),[W,H]=a.useState(null),[R,B]=a.useState([]),[Z,q]=a.useState(!1),[J,O]=a.useState("last24Hours"),[G,K]=a.useState(""),[Q,Y]=a.useState(""),[U,V]=a.useState(N),[X,_]=a.useState(1),[aa,ea]=a.useState(N?20:100),[ta,ra]=a.useState(0),[sa,la]=a.useState(0),[ia,oa]=a.useState(new Map),[na,da]=a.useState(new Map),ca=a.useRef(null),ma=a.useCallback((a,e)=>{if(!a||!e)return"";const t=a.compareType,r=a.value1||"",l=a.value2||"",i="fa"===M?e.unitFa||e.unit||"":e.unit||"";switch(t){case 1:return`${s("activeAlarmsPage.conditionEqual")} ${r} ${i}`;case 2:return`${s("activeAlarmsPage.conditionNotEqual")} ${r} ${i}`;case 3:return`${s("activeAlarmsPage.conditionHigher")} ${r} ${i}`;case 4:return`${s("activeAlarmsPage.conditionLower")} ${r} ${i}`;case 5:return`${s("activeAlarmsPage.conditionBetween")} ${r} ${s("and")} ${l} ${i}`;default:return""}},[M,s]);a.useEffect(()=>{(async()=>{try{E.log("Loading items and alarms from Zustand store");const[a,e]=await Promise.all([l.getStoredItems(),l.getStoredAlarms()]);if(a){const e=new Map;a.forEach(a=>{a.id&&e.set(a.id,a)}),oa(e),E.log("Items loaded from Zustand store",{count:e.size})}if(e){E.log("Alarms data received from Zustand store",{isArray:Array.isArray(e),count:Array.isArray(e)?e.length:"N/A",hasDataProperty:"data"in e,sample:Array.isArray(e)&&e.length>0?e[0]:null});const a=Array.isArray(e)?e:e?.data;if(Array.isArray(a)){const e=new Map;a.forEach(a=>{a.id&&e.set(a.id,a)}),da(e),E.log("Alarms loaded from Zustand store",{count:e.size})}else E.warn("Alarms data is not in expected format",{type:typeof a})}else E.warn("No alarms found in Zustand store")}catch(a){E.error("Error loading data from Zustand store:",a)}})()},[]);const ga=a.useMemo(()=>{const a=Math.floor(Date.now()/1e3);let e,t=a;switch(J){case"last24Hours":default:e=a-86400;break;case"last7Days":e=a-604800;break;case"last30Days":e=a-2592e3;break;case"custom":G&&Q?(e=Math.floor(new Date(G).getTime()/1e3),t=Math.floor(new Date(Q).getTime()/1e3)):e=a-86400}return{startDate:e,endDate:t}},[J,G,Q]),ua=a.useCallback(async(a,e)=>{H(null),q(!0);try{const{startDate:t,endDate:l}=ga;if(t>=l)return H(s("invalidDateRange")),void q(!1);const i={startDate:t,endDate:l,page:a,pageSize:e},o=await r(i);B(o.data||[]),ra(o.totalCount||0),la(o.totalPages||0),_(o.page||1),ea(o.pageSize||e),H(null),q(!1),E.log("Alarm history data fetched successfully",{count:o.data?.length||0,page:o.page,pageSize:o.pageSize,totalCount:o.totalCount,totalPages:o.totalPages,startDate:t,endDate:l})}catch(t){E.error("Error fetching alarm history data:",t),H(s("errorLoadingData")),q(!1)}},[ga,s]);a.useEffect(()=>{_(1),ua(1,aa)},[J]);const xa=a.useCallback((a,e)=>{_(e),ua(e,aa)},[aa,ua]),fa=a.useCallback(a=>{const e=Number(a.target.value);ea(e),_(1),ua(1,e)},[ua]),pa=a=>{const e=new Date(1e3*a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}T${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};a.useEffect(()=>{if("custom"===J&&!G&&!Q){const{startDate:a,endDate:e}=ga;K(pa(a)),Y(pa(e))}},[J,G,Q,ga]);const ha=a.useCallback(a=>{const t=a.isActive;return e.jsx(m,{label:s(t?"active":"inactive"),color:t?"error":"default",size:"small","data-id-ref":"alarm-status-chip-"+(t?"active":"inactive")})},[s]),ya=a.useMemo(()=>[{field:"itemName",headerText:s("activeAlarmsPage.itemName"),width:150,minWidth:120,allowSorting:!0,allowFiltering:!0},{field:"alarmLog",headerText:s("alarmMessage"),width:200,minWidth:150,allowSorting:!0,allowFiltering:!0},{field:"isActive",headerText:s("alarmStatus"),width:100,minWidth:80,allowSorting:!0,allowFiltering:!0,template:ha},{field:"condition",headerText:s("activeAlarmsPage.condition"),width:150,minWidth:120,allowSorting:!0,allowFiltering:!0},{field:"timeFormatted",headerText:s("time"),width:150,minWidth:120,allowSorting:!0,allowFiltering:!0}],[s,ha]),ja=a.useMemo(()=>Array.isArray(R)?R.map((a,e)=>{const t=n(a.time,M,"short"),r=a.itemId?ia.get(a.itemId):void 0,s=a.alarmId?na.get(a.alarmId):void 0;let l="";if(s&&(l="fa"===M?s.messageFa||s.message||"":s.message||"","fa"===M&&!s.messageFa&&s.message&&E.warn("[AlarmLogPage] Persian message (messageFa) not found for alarm, using English message",{alarmId:a.alarmId,englishMessage:s.message})),!l&&a.alarmLog)try{l=JSON.parse(a.alarmLog).Message||a.alarmLog}catch{E.warn("[AlarmLogPage] Failed to parse alarmLog JSON",{alarmLog:a.alarmLog}),l=a.alarmLog}const i=r?"fa"===M&&r.nameFa||r.name:a.itemId||"",o=ma(s,r);return{id:a.id||`alarm-${e}`,alarmId:a.alarmId||"",itemId:a.itemId||"",itemName:i,condition:o,time:a.time,timeFormatted:t,isActive:a.isActive,alarmLog:l}}):(E.warn("alarmHistoryData is not an array",{type:typeof R,value:R}),[]),[R,M,ia,na,ma]);return e.jsxs(g,{"data-id-ref":"alarm-log-page-container",sx:{display:"flex",flexDirection:"column",p:N?1:3,maxWidth:"100%",height:"100%",overflow:"hidden"},children:[e.jsxs(u,{"data-id-ref":"alarm-log-date-range-card",sx:{mb:3},children:[e.jsxs(g,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1.5,borderBottom:1,borderColor:"divider"},children:[e.jsx(x,{variant:"subtitle1",fontWeight:"bold","data-id-ref":"alarm-log-date-range-title",children:s("dateRange")}),N&&e.jsx(f,{size:"small",onClick:()=>V(a=>!a),"aria-expanded":!U,"data-id-ref":"alarm-log-date-range-collapse-button",children:U?e.jsx($,{}):e.jsx(I,{})})]}),e.jsx(p,{in:!N||!U,children:e.jsx(h,{sx:{p:N?2:3},"data-id-ref":"alarm-log-date-range-card-body",children:e.jsxs(g,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},alignItems:{xs:"stretch",md:"flex-end"},gap:2},children:[e.jsxs(y,{variant:"outlined",size:"small",sx:{flexWrap:"wrap"},"data-id-ref":"alarm-log-date-range-preset-buttons",children:[e.jsx(j,{variant:"last24Hours"===J?"contained":"outlined",onClick:()=>O("last24Hours"),"data-id-ref":"alarm-log-preset-last-24-hours",children:s("last24Hours")}),e.jsx(j,{variant:"last7Days"===J?"contained":"outlined",onClick:()=>O("last7Days"),"data-id-ref":"alarm-log-preset-last-7-days",children:s("last7Days")}),e.jsx(j,{variant:"last30Days"===J?"contained":"outlined",onClick:()=>O("last30Days"),"data-id-ref":"alarm-log-preset-last-30-days",children:s("last30Days")}),e.jsx(j,{variant:"custom"===J?"contained":"outlined",onClick:()=>O("custom"),"data-id-ref":"alarm-log-preset-custom",children:s("customRange")})]}),"custom"===J&&e.jsxs(e.Fragment,{children:[e.jsx(i,{id:"alarm-log-custom-start-date",value:G,onChange:K,"data-id-ref":"alarm-log-custom-start-date",className:"",dateLabel:s("startDate"),timeLabel:s("startTime")}),e.jsx(i,{id:"alarm-log-custom-end-date",value:Q,onChange:Y,"data-id-ref":"alarm-log-custom-end-date",className:"",dateLabel:s("endDate"),timeLabel:s("endTime")})]}),e.jsx(j,{variant:"contained",color:"success",size:"small",onClick:()=>{_(1),ua(1,aa)},disabled:Z,startIcon:Z?e.jsx(w,{size:20}):e.jsx(P,{}),"data-id-ref":"alarm-log-refresh-button",sx:{ml:{md:"auto"}},children:s("refresh")})]})})})]}),e.jsx(u,{"data-id-ref":"alarm-log-data-grid-card",sx:{flex:1,display:"flex",flexDirection:"column"},children:e.jsxs(h,{sx:{flex:1,display:"flex",flexDirection:"column",p:N?2:3},children:[e.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,flexWrap:"wrap",gap:1},children:[e.jsxs(x,{variant:"h6","data-id-ref":"alarm-log-grid-title",children:[s("alarmLog"),R.length>0&&e.jsx(m,{label:R.length,size:"small",color:"primary",sx:{ml:1},"data-id-ref":"alarm-log-count-chip"})]}),e.jsxs(y,{variant:"outlined",size:"small","data-id-ref":"alarm-log-export-buttons",children:[e.jsx(j,{onClick:()=>ca.current?.csvExport({fileName:`alarm-log-${Date.now()}.csv`}),disabled:Z||0===R.length,startIcon:e.jsx(F,{}),"data-id-ref":"alarm-log-export-csv-button",children:s("exportCsv")}),e.jsx(j,{onClick:()=>ca.current?.excelExport({fileName:`alarm-log-${Date.now()}.xlsx`}),disabled:Z||0===R.length,startIcon:e.jsx(L,{}),"data-id-ref":"alarm-log-export-excel-button",children:s("exportExcel")})]})]}),W&&e.jsx(v,{severity:"error",icon:e.jsx(k,{}),onClose:()=>H(null),sx:{mb:2},"data-id-ref":"alarm-log-error-alert",children:W}),Z&&e.jsxs(g,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:2},"data-id-ref":"alarm-log-loading-state",children:[e.jsx(w,{size:60}),e.jsx(x,{variant:"body1",color:"text.secondary",children:s("loadingData")})]}),!Z&&!W&&0===R.length&&e.jsxs(g,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:2},"data-id-ref":"alarm-log-empty-state",children:[e.jsx(z,{sx:{fontSize:80,color:"text.secondary",opacity:.5}}),e.jsx(x,{variant:"h6",color:"text.secondary",children:s("noAlarmsFound")}),e.jsx(x,{variant:"body2",color:"text.secondary",children:s("tryDifferentDateRange")})]}),!Z&&!W&&R.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(g,{sx:{flex:1,minHeight:0},"data-id-ref":"alarm-log-grid-container",children:e.jsx(o,{ref:ca,dataSource:ja,columns:ya,height:"100%",allowPaging:!1,allowSorting:!0,allowFiltering:!0,allowResizing:!0,allowExcelExport:!0,"data-id-ref":"alarm-log-grid"})}),e.jsxs(g,{"data-id-ref":"alarm-log-pagination",sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:"center",gap:2,pt:2,borderTop:`1px solid ${T.palette.divider}`},children:[e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:2},"data-id-ref":"alarm-log-pagination-info",children:[e.jsxs(b,{size:"small",sx:{minWidth:120},"data-id-ref":"alarm-log-page-size-select",children:[e.jsx(D,{children:s("auditTrailPage.pagination.rowsPerPage")}),e.jsxs(S,{value:aa,label:s("auditTrailPage.pagination.rowsPerPage"),onChange:fa,children:[e.jsx(A,{value:20,children:"20"}),e.jsx(A,{value:50,children:"50"}),e.jsx(A,{value:100,children:"100"}),e.jsx(A,{value:200,children:"200"})]})]}),e.jsx(x,{variant:"body2",color:"text.secondary","data-id-ref":"alarm-log-pagination-text",children:s("auditTrailPage.pagination.showing",{from:(X-1)*aa+1,to:Math.min(X*aa,ta),total:ta})})]}),e.jsx(C,{count:sa,page:X,onChange:xa,color:"primary",showFirstButton:!0,showLastButton:!0,siblingCount:1,boundaryCount:1,"data-id-ref":"alarm-log-pagination-component"})]})]})]})})]})};export{M as default};
