import{bI as s,bH as e,bQ as r}from"./vendor-TAwwu7tv.js";import{e as a,c as t,m as o,a as n}from"./layout-C1_h6sDC.js";import{g as i,i as c}from"./index-uPr0P1lU.js";import{B as l,C as d,q as u,r as m,a as g,w as p,x as y,y as f,c as h,j as x,v as b}from"./mui-core-im59jMHH.js";import{j,k as v,W as w,R as C,l as S,m as k,n as E}from"./mui-icons-v3eeVnKX.js";import{u as $,c as I,a as L}from"./react-router-B0bL9ISA.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./syncfusion-Czakt5fS.js";const R=t();function z(){const{state:{items:e},fetchGroups:r,fetchItems:t,fetchAlarms:n,setDataSynced:i}=a(),c=s.useRef(!1),l=s.useRef(e);l.current=e;const[d,u]=s.useState({overall:"idle",groups:{progress:0,status:"idle"},items:{progress:0,status:"idle"},alarms:{progress:0,status:"idle"},isCompleted:!1,hasErrors:!1}),m=s.useCallback(s=>{u(e=>({...e,groups:{...e.groups,...s}}))},[]),g=s.useCallback(s=>{u(e=>({...e,items:{...e.items,...s}}))},[]),p=s.useCallback(s=>{u(e=>({...e,alarms:{...e.alarms,...s}}))},[]),y=s.useCallback(s=>{u(e=>({...e,overall:s}))},[]),f=s.useCallback(async(s=!1)=>{m({progress:0,status:"loading",error:void 0});try{return m({progress:25}),await r(),m({progress:100,status:"success"}),!0}catch(e){const s=e instanceof Error?e.message:"Unknown error occurred";return m({progress:0,status:"error",error:s}),!1}},[r,m]),h=s.useCallback(async(s=!1)=>{g({progress:0,status:"loading",error:void 0});try{return g({progress:25}),await t(),g({progress:100,status:"success"}),!0}catch(e){const s=e instanceof Error?e.message:"Unknown error occurred";return g({progress:0,status:"error",error:s}),!1}},[t,g]),x=s.useCallback(async(s=[],e=!1)=>{p({progress:0,status:"loading",error:void 0});try{return p({progress:25}),await n(),p({progress:100,status:"success"}),!0}catch(r){const s=r instanceof Error?r.message:"Unknown error occurred";return p({progress:0,status:"error",error:s}),!1}},[n,p]),b=s.useCallback(async(s={})=>{const{forceRefresh:e=!1}=s;if(c.current)return!1;c.current=!0,y("syncing");try{u(s=>({...s,groups:{progress:0,status:"idle"},items:{progress:0,status:"idle"},alarms:{progress:0,status:"idle"},isCompleted:!1,hasErrors:!1}));const[s,r]=await Promise.all([f(e),h(e)]);let a=!1;if(r){await new Promise(s=>setTimeout(s,100));const s=l.current.map(s=>s.id);R.info("[useDataSync] Extracted item IDs for alarm sync:",{itemCount:s.length,sampleIds:s.slice(0,5),forceRefresh:e,timestamp:(new Date).toISOString()}),a=await x(s,e)}else p({progress:0,status:"error",error:"Cannot sync alarms: items sync failed"});const t=s&&r&&a;if(t){await new Promise(s=>setTimeout(s,500));const s=await o.getStoredGroups(),r=await o.getStoredItems(),a=await o.getStoredAlarms();if(R.log("Sync completed successfully. Verification:",{syncedDataCounts:{groups:s?.length||0,items:r?.length||0,alarms:a?.length||0},syncStatusSet:!0,forceRefresh:e}),!(s&&s.length>0&&r&&r.length>0))return R.error("Sync verification failed: Data not found in Zustand store after sync"),u(s=>({...s,overall:"error",isCompleted:!1,hasErrors:!0})),!1;i(!0),u(s=>({...s,overall:"completed",isCompleted:!0,hasErrors:!1}))}else u(s=>({...s,overall:"error",isCompleted:!1,hasErrors:!0}));return t}catch(r){return R.error("Sync process failed:",r),y("error"),u(s=>({...s,hasErrors:!0})),!1}finally{c.current=!1}},[f,h,x,y,p,i]),j=s.useCallback(async()=>{if(c.current)return!1;const s=[];if("error"===d.groups.status&&s.push(f()),"error"===d.items.status&&s.push(h()),"error"===d.alarms.status&&l.current.length>0){const e=l.current.map(s=>s.id);s.push(x(e))}if(0===s.length)return!0;c.current=!0,y("syncing");try{const e=(await Promise.all(s)).every(s=>s);if(e){await new Promise(s=>setTimeout(s,500));const s=await o.getStoredGroups(),e=await o.getStoredItems(),r=await o.getStoredAlarms();if(R.log("Retry completed successfully. Verification:",{syncedDataCounts:{groups:s?.length||0,items:e?.length||0,alarms:r?.length||0},syncStatusSet:!0}),!(s&&s.length>0&&e&&e.length>0))return R.error("Retry verification failed: Data not found in Zustand store"),u(s=>({...s,overall:"error",isCompleted:!1,hasErrors:!0})),!1;i(!0),u(s=>({...s,overall:"completed",isCompleted:!0,hasErrors:!1}))}else u(s=>({...s,overall:"error",isCompleted:!1,hasErrors:!0}));return e}catch(e){return R.error("Retry sync failed:",e),y("error"),!1}finally{c.current=!1}},[d.groups.status,d.items.status,d.alarms.status,f,h,x,y,i]),v=s.useCallback(()=>{u({overall:"idle",groups:{progress:0,status:"idle"},items:{progress:0,status:"idle"},alarms:{progress:0,status:"idle"},isCompleted:!1,hasErrors:!1})},[]);return{syncState:d,startSync:b,resetSync:v,retryFailed:j}}const N=t(),M=({title:e,description:a,progress:t,successMessage:o,errorMessage:n})=>{const i=s.useCallback(()=>{switch(t.status){case"success":return"success";case"error":return"error";case"loading":return"primary";default:return"secondary"}},[t.status]),c=s.useCallback(()=>{switch(t.status){case"success":return r.jsx(v,{sx:{color:"success.main"},"data-id-ref":`progress-icon-success-${e.toLowerCase()}`,"aria-label":"Success"});case"error":return r.jsx(E,{sx:{color:"error.main"},"data-id-ref":`progress-icon-error-${e.toLowerCase()}`,"aria-label":"Error"});case"loading":return r.jsx(x,{size:20,sx:{color:"primary.main"},"data-id-ref":`progress-icon-loading-${e.toLowerCase()}`,"aria-label":"Loading"});default:return r.jsx(k,{sx:{color:"text.disabled"},"data-id-ref":`progress-icon-idle-${e.toLowerCase()}`,"aria-label":"Waiting"})}},[t.status,e]),d=s.useCallback(()=>{switch(t.status){case"success":return o;case"error":return t.error||n;default:return a}},[t.status,t.error,o,n,a]);return r.jsxs(l,{className:"sync-progress-item",sx:{mb:2},"data-id-ref":`sync-progress-${e.toLowerCase()}`,role:"region","aria-labelledby":`progress-title-${e.toLowerCase()}`,children:[r.jsxs(p,{direction:"row",alignItems:"center",spacing:1,sx:{mb:1},"data-id-ref":`progress-header-${e.toLowerCase()}`,children:[r.jsx(l,{className:"sync-status-icon","data-id-ref":`progress-icon-container-${e.toLowerCase()}`,"aria-hidden":"true",children:c()}),r.jsxs(l,{sx:{flexGrow:1},"data-id-ref":`progress-content-${e.toLowerCase()}`,children:[r.jsx(g,{variant:"subtitle2",sx:{fontWeight:600,mb:0},"data-id-ref":`progress-title-${e.toLowerCase()}`,id:`progress-title-${e.toLowerCase()}`,children:e}),r.jsx(g,{variant:"caption",sx:{color:"text.secondary",display:"block"},"data-id-ref":`progress-message-${e.toLowerCase()}`,id:`progress-message-${e.toLowerCase()}`,children:d()})]})]}),r.jsx(f,{variant:"determinate",value:t.progress,color:i(),className:"sync-progress-bar","data-id-ref":`progress-bar-${e.toLowerCase()}`,"aria-labelledby":`progress-title-${e.toLowerCase()}`,"aria-describedby":`progress-message-${e.toLowerCase()}`,sx:{height:8,borderRadius:1}})]})},D=()=>{const{t}=n(),o=$(),[k]=I(),E=L(),{syncState:R,startSync:D,retryFailed:P}=z(),{clearDataSyncStatus:W}=a(),T=s.useMemo(()=>i(k,E.state,"/dashboard"),[k,E.state]),A="true"===k.get("force"),[F,G]=s.useState(!1),U=e.useRef(!1),H=e.useRef(null);s.useEffect(()=>{A?(W(),D({forceRefresh:!0})):D()},[A,W,D]),s.useEffect(()=>(R.isCompleted&&!U.current&&(U.current=!0,G(!0),N.log("[SyncPage] Sync completed, initiating redirect to:",T),c().catch(s=>{N.warn("[Sync] Failed to invalidate cache:",s)}),H.current&&clearTimeout(H.current),H.current=window.setTimeout(()=>{N.log("[SyncPage] Redirecting now to:",T),o(T,{replace:!0})},1500)),()=>{H.current&&!U.current&&(N.log("[SyncPage] Component unmounting, clearing timer"),clearTimeout(H.current),H.current=null)}),[R.isCompleted,o,T]);const V=s.useCallback(()=>{P()},[P]),Z=s.useCallback(()=>{o(T,{replace:!0})},[o,T]),q=s.useMemo(()=>Math.round((R.groups.progress+R.items.progress+R.alarms.progress)/3),[R.groups.progress,R.items.progress,R.alarms.progress]);return r.jsx(l,{className:"sync-page","data-id-ref":"sync-page",role:"main","aria-live":"polite",sx:{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:s=>`linear-gradient(135deg, ${s.palette.primary.main} 0%, ${s.palette.secondary.main} 100%)`,padding:{xs:2,sm:3,md:4}},children:r.jsx(d,{maxWidth:"md","data-id-ref":"sync-page-container",sx:{display:"flex",justifyContent:"center",alignItems:"center"},children:r.jsx(l,{sx:{width:"100%",maxWidth:{xs:"100%",sm:"90%",md:"75%",lg:"60%",xl:"50%"}},"data-id-ref":"sync-page-col",children:r.jsx(u,{component:"section",className:"sync-card",elevation:8,"data-id-ref":"sync-card","aria-labelledby":"sync-title","aria-describedby":"sync-subtitle",sx:{borderRadius:{xs:2,md:3},overflow:"hidden"},children:r.jsxs(m,{"data-id-ref":"sync-card-body",sx:{padding:{xs:3,md:4}},children:[r.jsxs(l,{component:"header",sx:{textAlign:"center",mb:3},"data-id-ref":"sync-header",children:[r.jsx(l,{className:"sync-logo",sx:{mb:2},"data-id-ref":"sync-logo","aria-hidden":"true",children:r.jsx(j,{className:"sync-icon","data-id-ref":"sync-icon",sx:{fontSize:{xs:48,md:64},color:"primary.main",animation:"syncing"===R.overall?"spin 2s linear infinite":"none","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}})}),r.jsx(g,{variant:"h4",component:"h1",className:"sync-title",sx:{mb:1,fontWeight:600,fontSize:{xs:"1.5rem",md:"2rem"}},"data-id-ref":"sync-title",id:"sync-title",children:t("sync.title")}),r.jsx(g,{variant:"body2",className:"sync-subtitle",sx:{color:"text.secondary",mb:0},"data-id-ref":"sync-subtitle",id:"sync-subtitle",children:t("sync.subtitle")})]}),r.jsxs(l,{component:"section",sx:{mb:3},"data-id-ref":"sync-overall-progress-section","aria-labelledby":"overall-progress-label",children:[r.jsxs(p,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:2},"data-id-ref":"sync-overall-progress-header",children:[r.jsx(g,{variant:"body1",sx:{fontWeight:500},"data-id-ref":"sync-overall-progress-label",id:"overall-progress-label",children:t("sync.title")}),r.jsx(y,{label:`${q}%`,color:"primary",size:"small","data-id-ref":"sync-overall-progress-badge","aria-label":`${q} percent complete`})]}),r.jsx(f,{variant:"determinate",value:q,className:"sync-overall-progress","data-id-ref":"sync-overall-progress-bar","aria-labelledby":"overall-progress-label",sx:{height:10,borderRadius:1}})]}),r.jsxs(l,{component:"section",className:"sync-progress-list","data-id-ref":"sync-progress-list","aria-label":"Individual synchronization progress",children:[r.jsx(M,{title:t("sync.groups.title"),description:t("sync.groups.description"),progress:R.groups,successMessage:t("sync.groups.success"),errorMessage:t("sync.groups.error")}),r.jsx(M,{title:t("sync.items.title"),description:t("sync.items.description"),progress:R.items,successMessage:t("sync.items.success"),errorMessage:t("sync.items.error")}),r.jsx(M,{title:t("sync.alarms.title"),description:t("sync.alarms.description"),progress:R.alarms,successMessage:t("sync.alarms.success"),errorMessage:t("sync.alarms.error")})]}),r.jsxs(l,{component:"section",className:"sync-status-messages",sx:{mt:3},"data-id-ref":"sync-status-messages","aria-label":"Synchronization status messages",children:["syncing"===R.overall&&!R.hasErrors&&r.jsx(h,{severity:"info",icon:r.jsx(x,{size:20}),"data-id-ref":"sync-status-syncing",role:"status","aria-live":"polite",sx:{display:"flex",alignItems:"center"},children:r.jsx(g,{variant:"body2","data-id-ref":"sync-status-syncing-text",children:t("sync.completing")})}),R.isCompleted&&r.jsx(h,{severity:"success",icon:r.jsx(v,{}),"data-id-ref":"sync-status-completed",role:"status","aria-live":"polite",sx:{display:"flex",alignItems:"center"},children:r.jsx(g,{variant:"body2","data-id-ref":"sync-status-completed-text",children:t(F?"sync.redirecting":"sync.completing")})}),R.hasErrors&&r.jsxs(h,{severity:"error","data-id-ref":"sync-status-error",role:"alert","aria-live":"assertive",children:[r.jsxs(p,{direction:"row",alignItems:"center",spacing:1,sx:{mb:2},"data-id-ref":"sync-status-error-header",children:[r.jsx(w,{"data-id-ref":"sync-status-error-icon","aria-label":"Error"}),r.jsx(g,{variant:"body2","data-id-ref":"sync-status-error-text",children:t("sync.errors.synchronizationFailed")})]}),r.jsxs(p,{direction:{xs:"column",sm:"row"},spacing:1,"data-id-ref":"sync-status-error-actions",sx:{flexWrap:"wrap"},children:[r.jsx(b,{variant:"outlined",color:"error",size:"small",onClick:V,"data-id-ref":"sync-retry-button",disabled:"syncing"===R.overall,"aria-label":"Retry failed synchronization operations",startIcon:r.jsx(C,{"data-id-ref":"sync-retry-button-icon","aria-hidden":"true"}),children:t("sync.retry")}),r.jsx(b,{variant:"outlined",color:"secondary",size:"small",onClick:Z,"data-id-ref":"sync-skip-button","aria-label":"Skip synchronization and continue to dashboard",startIcon:r.jsx(S,{"data-id-ref":"sync-skip-button-icon","aria-hidden":"true"}),children:t("sync.skipAndContinue")})]})]})]})]})})})})})};export{D as default};
