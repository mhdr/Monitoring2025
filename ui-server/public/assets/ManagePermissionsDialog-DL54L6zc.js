import{bI as e,bH as s,bQ as a}from"./vendor-TAwwu7tv.js";import{a as r,f as n,c as i}from"./layout-C1_h6sDC.js";import{g as t,s as o}from"./UsersPage-BulyG3ME.js";import{z as l,E as m,B as d,a as c,F as u,c as g,t as p,W as h,j as f,G as x,H as j,ab as b,O as v,v as y}from"./mui-core-im59jMHH.js";import{ah as F,al as C}from"./mui-icons-v3eeVnKX.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./react-router-B0bL9ISA.js";import"./SyncfusionGridWrapper-je9qfgPl.js";import"./index-uPr0P1lU.js";import"./syncfusion-Czakt5fS.js";const I=i(),M=({open:i,user:M,onClose:k})=>{const{t:N,language:S}=r(),w=n(e=>e.items),W=n(e=>e.groups),[$,H]=e.useState(!1),[z,A]=e.useState(!1),[E,L]=e.useState(null),[P,U]=e.useState([]),[G,B]=e.useState(""),D=async e=>{A(!0);try{I.log("Fetching user permissions",{userId:e});const s=await t(e);U(s.itemIds||[]),I.log("User permissions fetched",{count:s.itemIds?.length||0})}catch(s){I.error("Failed to fetch user permissions",{error:s}),L(N("permissionsManagement.errors.fetchFailed"))}finally{A(!1)}};e.useEffect(()=>{i&&M&&M.id&&(D(M.id),L(null),B(""))},[i,M]);const O=e.useMemo(()=>{const e=new Map;return W.forEach(s=>{e.set(s.id,s)}),e},[W]),Q=s.useCallback(e=>{if(!e)return"";const s=[];let a=e;for(;a;){const e=O.get(a);if(!e)break;const r="fa"===S&&e.nameFa?e.nameFa:e.name;s.unshift(r),a=e.parentId}return s.join(" / ")},[O,S]),R=e.useMemo(()=>{let e=[...w];if(G.trim()){const s=G.toLowerCase();e=e.filter(e=>{const a="fa"===S&&e.nameFa?e.nameFa:e.name,r=Q(e.groupId);return a.toLowerCase().includes(s)||r.toLowerCase().includes(s)})}return e.sort((e,s)=>{const a=Q(e.groupId),r=Q(s.groupId);if(a!==r)return a.localeCompare(r);const n="fa"===S&&e.nameFa?e.nameFa:e.name,i="fa"===S&&s.nameFa?s.nameFa:s.name;return n.localeCompare(i)}),e},[w,G,S,Q]),q=()=>{k(!1)},J=R.length>0&&P.length===R.length,K=P.length>0&&P.length<R.length;return a.jsxs(l,{open:i,onClose:q,maxWidth:"md",fullWidth:!0,"data-id-ref":"manage-permissions-dialog",children:[a.jsx(m,{"data-id-ref":"manage-permissions-dialog-title",children:a.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[a.jsx(F,{color:"primary"}),a.jsx(c,{variant:"h6",children:N("permissionsManagement.managePermissions")})]})}),a.jsxs(u,{"data-id-ref":"manage-permissions-dialog-content",children:[E&&a.jsx(g,{"data-id-ref":"manage-permissions-error",severity:"error",onClose:()=>L(null),sx:{mb:2},children:E}),a.jsx(c,{variant:"body2",color:"text.secondary",sx:{mb:2},children:N("permissionsManagement.dialogs.manageMessage",{userName:M?"fa"===S&&M.firstNameFa&&M.lastNameFa?`${M.firstNameFa} ${M.lastNameFa}`:`${M.firstName||""} ${M.lastName||""}`.trim()||M.userName||"":""})}),a.jsx(d,{sx:{mb:2},children:a.jsx(p,{"data-id-ref":"permissions-search-field",fullWidth:!0,size:"small",placeholder:N("permissionsManagement.searchItems"),value:G,onChange:e=>B(e.target.value),InputProps:{startAdornment:a.jsx(h,{position:"start",children:a.jsx(C,{})})}})}),z?a.jsx(d,{sx:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:200},"data-id-ref":"permissions-loading",children:a.jsx(f,{})}):a.jsxs(a.Fragment,{children:[a.jsx(d,{sx:{mb:1},children:a.jsx(x,{"data-id-ref":"permissions-select-all-checkbox",control:a.jsx(j,{checked:J,indeterminate:K,onChange:()=>{P.length===R.length?U([]):U(R.map(e=>e.id))},disabled:$||0===R.length}),label:a.jsxs(c,{variant:"body2",fontWeight:"bold",children:[N("permissionsManagement.selectAll")," (",P.length," / ",w.length,")"]})})}),a.jsxs(d,{sx:{maxHeight:400,overflow:"auto",border:1,borderColor:"divider",borderRadius:1,p:1},"data-id-ref":"permissions-items-container",children:[a.jsx(b,{"data-id-ref":"permissions-checkbox-group",children:R.map(e=>{const s="fa"===S&&e.nameFa?e.nameFa:e.name,r=Q(e.groupId);return a.jsx(x,{"data-id-ref":`permission-checkbox-${e.id}`,control:a.jsx(j,{checked:P.includes(e.id),onChange:()=>{return s=e.id,void U(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s]);var s},disabled:$}),label:a.jsxs(d,{children:[a.jsx(c,{variant:"body2",children:s}),r&&a.jsx(c,{variant:"caption",color:"text.secondary",children:r})]})},e.id)})}),0===R.length&&a.jsx(g,{severity:"info","data-id-ref":"no-items-alert",children:N(G?"permissionsManagement.errors.noItemsMatchSearch":"permissionsManagement.errors.noItemsAvailable")})]})]})]}),a.jsxs(v,{"data-id-ref":"manage-permissions-dialog-actions",children:[a.jsx(y,{"data-id-ref":"cancel-manage-permissions-btn",onClick:q,disabled:$,children:N("common.buttons.cancel")}),a.jsx(y,{"data-id-ref":"save-permissions-btn",onClick:async()=>{if(M&&M.id){H(!0),L(null);try{I.log("Saving user permissions",{userId:M.id,userName:M.userName,itemCount:P.length});const e=await o(M.id,P);e.success?(I.log("User permissions saved successfully",{userId:M.id,message:e.message,permissionsCount:e.permissionsCount}),k(!0)):L(e.message||N("permissionsManagement.errors.saveFailed"))}catch(e){I.error("Failed to save user permissions",{error:e}),L(N("permissionsManagement.errors.saveFailed"))}finally{H(!1)}}else I.error("Cannot save permissions: user or user ID is null")},variant:"contained",color:"primary",disabled:$||z,startIcon:$&&a.jsx(f,{size:20}),children:N($?"common.loading":"common.buttons.save")})]})]})};export{M as default};
