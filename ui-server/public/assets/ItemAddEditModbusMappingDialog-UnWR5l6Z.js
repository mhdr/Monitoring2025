import{bI as o,bQ as e}from"./vendor-TAwwu7tv.js";import{a as t,am as i,c as n}from"./layout-C1_h6sDC.js";import{z as r,E as a,F as l,c as s,B as d,a as p,ac as m,t as c,J as u,K as g,N as b,b as h,O as I,v as f,j as x}from"./mui-core-im59jMHH.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./mui-icons-v3eeVnKX.js";import"./react-router-B0bL9ISA.js";const j=n(),v=({open:n,editMode:v,mapping:C,itemId:y,itemName:M,controllers:T,existingPositionsByController:S,onClose:N,onSuccess:W})=>{const{t:w}=t(),[F,O]=o.useState(!1),[k,E]=o.useState(null),[P,$]=o.useState({controllerId:"",position:0,operationType:1}),[q,z]=o.useState({});o.useEffect(()=>{if(n){if(v&&C)$({controllerId:C.controllerId,position:C.position,operationType:C.operationType??1});else{const o=T.length>0?T[0].id:"",e=S.get(o)||[],t=e.length>0?Math.max(...e)+1:0;$({controllerId:o,position:t,operationType:1})}z({}),E(null)}},[n,v,C,T,S]);const A=o.useMemo(()=>T.find(o=>o.id===P.controllerId)||null,[T,P.controllerId]),B=o.useMemo(()=>S.get(P.controllerId)||[],[S,P.controllerId]),U=()=>{const o={};return P.controllerId||(o.controllerId=w("itemModbusMappings.validation.controllerRequired")),P.position<0&&(o.position=w("modbusControllers.validation.positionMin")),B.some(o=>!(v&&C&&C.position===o&&C.controllerId===P.controllerId||o!==P.position))&&(o.position=w("modbusControllers.validation.duplicatePosition")),z(o),0===Object.keys(o).length},J=()=>{E(null),z({}),N(!1)};return e.jsxs(r,{open:n,onClose:J,maxWidth:"sm",fullWidth:!0,"data-id-ref":"item-add-edit-modbus-mapping-dialog",children:[e.jsx(a,{"data-id-ref":"item-add-edit-modbus-mapping-dialog-title",children:w(v?"modbusControllers.mappings.dialogs.editTitle":"modbusControllers.mappings.dialogs.addTitle")}),e.jsxs(l,{"data-id-ref":"item-add-edit-modbus-mapping-dialog-content",children:[k&&e.jsx(s,{"data-id-ref":"item-add-edit-modbus-mapping-error",severity:"error",onClose:()=>E(null),sx:{mb:2,mt:1},children:k}),e.jsxs(d,{sx:{mb:2,mt:1},children:[e.jsx(p,{variant:"caption",color:"text.secondary",children:w("modbusControllers.mappings.item")}),e.jsx(p,{variant:"body2","data-id-ref":"item-mapping-item-name",children:M})]}),e.jsx(m,{"data-id-ref":"item-mapping-controller-autocomplete",options:T,value:A,onChange:(o,e)=>{const t=e?.id||"",i=S.get(t)||[],n=i.length>0?Math.max(...i)+1:0;$(o=>({...o,controllerId:t,position:n})),q.controllerId&&z(o=>({...o,controllerId:void 0}))},getOptionLabel:o=>`${o.name} (${o.ipAddress}:${o.port})`,isOptionEqualToValue:(o,e)=>o.id===e.id,renderInput:o=>e.jsx(c,{...o,"data-id-ref":"item-mapping-controller-input",label:w("itemModbusMappings.controllerName"),error:!!q.controllerId,helperText:q.controllerId,margin:"normal"}),fullWidth:!0,disabled:v}),e.jsx(c,{"data-id-ref":"item-mapping-position-input",label:w("modbusControllers.mappings.position"),type:"number",value:P.position,onChange:o=>{const e=parseInt(o.target.value,10);$(o=>({...o,position:isNaN(e)?0:e})),q.position&&z(o=>({...o,position:void 0}))},error:!!q.position,helperText:q.position,fullWidth:!0,margin:"normal",inputProps:{min:0}}),e.jsxs(u,{"data-id-ref":"item-mapping-operation-type-control",fullWidth:!0,margin:"normal",children:[e.jsx(g,{children:w("modbusControllers.mappings.operationType")}),e.jsxs(b,{"data-id-ref":"item-mapping-operation-type-select",value:P.operationType,onChange:o=>{$(e=>({...e,operationType:o.target.value}))},label:w("modbusControllers.mappings.operationType"),children:[e.jsx(h,{value:1,children:w("modbusControllers.mappings.read")}),e.jsx(h,{value:2,children:w("modbusControllers.mappings.write")})]})]})]}),e.jsxs(I,{"data-id-ref":"item-add-edit-modbus-mapping-dialog-actions",children:[e.jsx(f,{"data-id-ref":"item-cancel-modbus-mapping-btn",onClick:J,disabled:F,children:w("common.buttons.cancel")}),e.jsx(f,{"data-id-ref":"item-save-modbus-mapping-btn",onClick:async()=>{if(U()){O(!0),E(null);try{const o={position:P.position,itemId:y,operationType:P.operationType};let e;if(v&&C){if(C.controllerId!==P.controllerId){const t={controllerId:C.controllerId,added:[],changed:[],removed:[C.id]};await i(t),e={controllerId:P.controllerId,added:[o],changed:[],removed:[]}}else o.id=C.id,e={controllerId:P.controllerId,added:[],changed:[o],removed:[]};j.log("Updating mapping",{mappingId:C.id,controllerChanged:C.controllerId!==P.controllerId})}else e={controllerId:P.controllerId,added:[o],changed:[],removed:[]},j.log("Adding new mapping");const t=await i(e);if(t.isSuccessful){const o=w(v?"modbusControllers.success.mappingUpdated":"modbusControllers.success.mappingCreated");j.log(v?"Mapping updated":"Mapping created"),W(o),N(!0)}else E(t.errorMessage||w("modbusControllers.errors.saveMappingsFailed"))}catch(o){j.error("Failed to save mapping",{error:o}),E(w("modbusControllers.errors.saveMappingsFailed"))}finally{O(!1)}}},variant:"contained",color:"primary",disabled:F||0===T.length,startIcon:F&&e.jsx(x,{size:20}),children:w(F?"common.loading":"common.buttons.save")})]})]})};export{v as default};
