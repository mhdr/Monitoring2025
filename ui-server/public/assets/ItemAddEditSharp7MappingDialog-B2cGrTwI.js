import{bI as e,bQ as t}from"./vendor-TAwwu7tv.js";import{a as o,ah as i,c as r}from"./layout-C1_h6sDC.js";import{D as a}from"./api-D5q9v5qU.js";import{z as n,E as l,F as s,c as p,B as d,a as m,ac as c,t as g,J as h,K as u,N as b,b as I,O as f,v as x,j as v}from"./mui-core-im59jMHH.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./mui-icons-v3eeVnKX.js";import"./react-router-B0bL9ISA.js";const j=r(),y=({open:r,editMode:y,mapping:C,itemId:T,itemName:M,controllers:S,existingPositionsByController:N,onClose:W,onSuccess:B})=>{const{t:F}=o(),[w,O]=e.useState(!1),[P,k]=e.useState(null),[A,E]=e.useState({controllerId:"",position:0,bit:null,operationType:1}),[$,q]=e.useState({});e.useEffect(()=>{if(r){if(y&&C)E({controllerId:C.controllerId,position:C.position,bit:C.bit??null,operationType:C.operationType??1});else{const e=S.length>0?S[0].id:"",t=N.get(e)||[],o=t.length>0?Math.max(...t)+1:0;E({controllerId:e,position:o,bit:null,operationType:1})}q({}),k(null)}},[r,y,C,S,N]);const z=e.useMemo(()=>S.find(e=>e.id===A.controllerId)||null,[S,A.controllerId]),D=e.useMemo(()=>z?.dataType===a.Bit,[z]),R=e.useMemo(()=>N.get(A.controllerId)||[],[N,A.controllerId]),U=()=>{const e={};return A.controllerId||(e.controllerId=F("itemSharp7Mappings.validation.controllerRequired")),A.position<0&&(e.position=F("sharp7Controllers.validation.positionMin")),R.some(e=>!(y&&C&&C.position===e&&C.controllerId===A.controllerId||e!==A.position))&&(e.position=F("sharp7Controllers.validation.duplicatePosition")),D&&null!==A.bit&&(A.bit<0||A.bit>7)&&(e.bit=F("itemSharp7Mappings.validation.bitRange")),q(e),0===Object.keys(e).length},H=()=>{k(null),q({}),W(!1)};return t.jsxs(n,{open:r,onClose:H,maxWidth:"sm",fullWidth:!0,"data-id-ref":"item-add-edit-sharp7-mapping-dialog",children:[t.jsx(l,{"data-id-ref":"item-add-edit-sharp7-mapping-dialog-title",children:F(y?"sharp7Controllers.mappings.dialogs.editTitle":"sharp7Controllers.mappings.dialogs.addTitle")}),t.jsxs(s,{"data-id-ref":"item-add-edit-sharp7-mapping-dialog-content",children:[P&&t.jsx(p,{"data-id-ref":"item-add-edit-sharp7-mapping-error",severity:"error",onClose:()=>k(null),sx:{mb:2,mt:1},children:P}),t.jsxs(d,{sx:{mb:2,mt:1},children:[t.jsx(m,{variant:"caption",color:"text.secondary",children:F("sharp7Controllers.mappings.item")}),t.jsx(m,{variant:"body2","data-id-ref":"item-sharp7-mapping-item-name",children:M})]}),t.jsx(c,{"data-id-ref":"item-sharp7-mapping-controller-autocomplete",options:S,value:z,onChange:(e,t)=>{const o=t?.id||"",i=N.get(o)||[],r=i.length>0?Math.max(...i)+1:0,n=t?.dataType!==a.Bit;E(e=>({...e,controllerId:o,position:r,bit:n?null:e.bit})),$.controllerId&&q(e=>({...e,controllerId:void 0}))},getOptionLabel:e=>`${e.name} (${e.ipAddress} - DB${e.dbAddress})`,isOptionEqualToValue:(e,t)=>e.id===t.id,renderInput:e=>t.jsx(g,{...e,"data-id-ref":"item-sharp7-mapping-controller-input",label:F("itemSharp7Mappings.controllerName"),error:!!$.controllerId,helperText:$.controllerId,margin:"normal"}),fullWidth:!0,disabled:y}),t.jsx(g,{"data-id-ref":"item-sharp7-mapping-position-input",label:F("sharp7Controllers.mappings.position"),type:"number",value:A.position,onChange:e=>{const t=parseInt(e.target.value,10);E(e=>({...e,position:isNaN(t)?0:t})),$.position&&q(e=>({...e,position:void 0}))},error:!!$.position,helperText:$.position,fullWidth:!0,margin:"normal",inputProps:{min:0}}),D&&t.jsx(g,{"data-id-ref":"item-sharp7-mapping-bit-input",label:F("itemSharp7Mappings.bit"),type:"number",value:A.bit??"",onChange:e=>{const t=""===e.target.value?null:parseInt(e.target.value,10);E(e=>({...e,bit:null===t||isNaN(t)?null:t})),$.bit&&q(e=>({...e,bit:void 0}))},error:!!$.bit,helperText:$.bit||F("itemSharp7Mappings.bitHelperText"),fullWidth:!0,margin:"normal",inputProps:{min:0,max:7}}),t.jsxs(h,{"data-id-ref":"item-sharp7-mapping-operation-type-control",fullWidth:!0,margin:"normal",children:[t.jsx(u,{children:F("sharp7Controllers.mappings.operationType")}),t.jsxs(b,{"data-id-ref":"item-sharp7-mapping-operation-type-select",value:A.operationType,onChange:e=>{E(t=>({...t,operationType:e.target.value}))},label:F("sharp7Controllers.mappings.operationType"),children:[t.jsx(I,{value:1,children:F("sharp7Controllers.mappings.read")}),t.jsx(I,{value:2,children:F("sharp7Controllers.mappings.write")})]})]})]}),t.jsxs(f,{"data-id-ref":"item-add-edit-sharp7-mapping-dialog-actions",children:[t.jsx(x,{"data-id-ref":"item-sharp7-cancel-mapping-btn",onClick:H,disabled:w,children:F("common.buttons.cancel")}),t.jsx(x,{"data-id-ref":"item-sharp7-save-mapping-btn",onClick:async()=>{if(U()){O(!0),k(null);try{const e={position:A.position,bit:D?A.bit:null,itemId:T,operationType:A.operationType};let t;if(y&&C){if(C.controllerId!==A.controllerId){const o={controllerId:C.controllerId,added:[],changed:[],removed:[C.id]};await i(o),t={controllerId:A.controllerId,added:[e],changed:[],removed:[]}}else e.id=C.id,t={controllerId:A.controllerId,added:[],changed:[e],removed:[]};j.log("Updating mapping",{mappingId:C.id,controllerChanged:C.controllerId!==A.controllerId})}else t={controllerId:A.controllerId,added:[e],changed:[],removed:[]},j.log("Adding new mapping");const o=await i(t);if(o.isSuccessful){const e=F(y?"sharp7Controllers.success.mappingUpdated":"sharp7Controllers.success.mappingCreated");j.log(y?"Mapping updated":"Mapping created"),B(e),W(!0)}else k(o.errorMessage||F("sharp7Controllers.errors.saveMappingsFailed"))}catch(e){j.error("Failed to save mapping",{error:e}),k(F("sharp7Controllers.errors.saveMappingsFailed"))}finally{O(!1)}}},variant:"contained",color:"primary",disabled:w||0===S.length,startIcon:w&&t.jsx(v,{size:20}),children:F(w?"common.loading":"common.buttons.save")})]})]})};export{y as default};
