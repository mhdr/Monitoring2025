import{bI as o,bQ as e}from"./vendor-TAwwu7tv.js";import{a as i,c as t,am as s}from"./layout-C1_h6sDC.js";import{z as a,E as n,F as d,c as r,t as p,ac as l,J as m,K as u,N as c,b as g,O as b,v as f,j as h}from"./mui-core-im59jMHH.js";import"./date-utils-hKKKzaQW.js";import"./i18n-BrX_VL2O.js";import"./mui-icons-v3eeVnKX.js";import"./react-router-B0bL9ISA.js";const j=t(),x=({open:t,editMode:x,mapping:C,controllerId:I,modbusItems:v,existingPositions:y,onClose:T,onSuccess:M})=>{const{t:S}=i(),[O,W]=o.useState(!1),[F,N]=o.useState(null),[k,w]=o.useState({position:0,itemId:"",operationType:1}),[E,P]=o.useState({});o.useEffect(()=>{if(t){if(x&&C)w({position:C.position,itemId:C.itemId,operationType:C.operationType??1});else{const o=y.length>0?Math.max(...y)+1:0;w({position:o,itemId:"",operationType:1})}P({}),N(null)}},[t,x,C,y]);const q=o.useMemo(()=>v.find(o=>o.id===k.itemId)||null,[v,k.itemId]),z=()=>{const o={};return k.position<0&&(o.position=S("modbusControllers.validation.positionMin")),y.some((o,e)=>(!x||!C||e!==y.indexOf(C.position))&&o===k.position)&&(o.position=S("modbusControllers.validation.duplicatePosition")),k.itemId||(o.itemId=S("modbusControllers.validation.itemRequired")),P(o),0===Object.keys(o).length},U=()=>{N(null),P({}),T(!1)};return e.jsxs(a,{open:t,onClose:U,maxWidth:"sm",fullWidth:!0,"data-id-ref":"add-edit-modbus-mapping-dialog",children:[e.jsx(n,{"data-id-ref":"add-edit-modbus-mapping-dialog-title",children:S(x?"modbusControllers.mappings.dialogs.editTitle":"modbusControllers.mappings.dialogs.addTitle")}),e.jsxs(d,{"data-id-ref":"add-edit-modbus-mapping-dialog-content",children:[F&&e.jsx(r,{"data-id-ref":"add-edit-modbus-mapping-error",severity:"error",onClose:()=>N(null),sx:{mb:2,mt:1},children:F}),e.jsx(p,{"data-id-ref":"modbus-mapping-position-input",label:S("modbusControllers.mappings.position"),type:"number",value:k.position,onChange:o=>{const e=parseInt(o.target.value,10);w(o=>({...o,position:isNaN(e)?0:e})),E.position&&P(o=>({...o,position:void 0}))},error:!!E.position,helperText:E.position,fullWidth:!0,margin:"normal",inputProps:{min:0}}),e.jsx(l,{"data-id-ref":"modbus-mapping-item-autocomplete",options:v,value:q,onChange:(o,e)=>{w(o=>({...o,itemId:e?.id||""})),E.itemId&&P(o=>({...o,itemId:void 0}))},getOptionLabel:o=>`${o.pointNumber} - ${o.name}`,isOptionEqualToValue:(o,e)=>o.id===e.id,renderInput:o=>e.jsx(p,{...o,"data-id-ref":"modbus-mapping-item-input",label:S("modbusControllers.mappings.item"),error:!!E.itemId,helperText:E.itemId,margin:"normal"}),fullWidth:!0,sx:{mt:1}}),e.jsxs(m,{"data-id-ref":"modbus-mapping-operation-type-control",fullWidth:!0,margin:"normal",children:[e.jsx(u,{children:S("modbusControllers.mappings.operationType")}),e.jsxs(c,{"data-id-ref":"modbus-mapping-operation-type-select",value:k.operationType,onChange:o=>{w(e=>({...e,operationType:o.target.value}))},label:S("modbusControllers.mappings.operationType"),children:[e.jsx(g,{value:1,children:S("modbusControllers.mappings.read")}),e.jsx(g,{value:2,children:S("modbusControllers.mappings.write")})]})]})]}),e.jsxs(b,{"data-id-ref":"add-edit-modbus-mapping-dialog-actions",children:[e.jsx(f,{"data-id-ref":"cancel-modbus-mapping-btn",onClick:U,disabled:O,children:S("common.buttons.cancel")}),e.jsx(f,{"data-id-ref":"save-modbus-mapping-btn",onClick:async()=>{if(z()){W(!0),N(null);try{const o={position:k.position,itemId:k.itemId,operationType:k.operationType};let e;x&&C?(o.id=C.id,e={controllerId:I,added:[],changed:[o],removed:[]},j.log("Updating mapping",{mappingId:C.id})):(e={controllerId:I,added:[o],changed:[],removed:[]},j.log("Adding new mapping"));const i=await s(e);if(i.isSuccessful){const o=S(x?"modbusControllers.success.mappingUpdated":"modbusControllers.success.mappingCreated");j.log(x?"Mapping updated":"Mapping created"),M(o),T(!0)}else N(i.errorMessage||S("modbusControllers.errors.saveMappingsFailed"))}catch(o){j.error("Failed to save mapping",{error:o}),N(S("modbusControllers.errors.saveMappingsFailed"))}finally{W(!1)}}},variant:"contained",color:"primary",disabled:O,startIcon:O&&e.jsx(h,{size:20}),children:S(O?"common.loading":"common.buttons.save")})]})]})};export{x as default};
